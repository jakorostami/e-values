<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
<title>The E-Value ‚Äî Game-Theoretic Evidence</title>
<style>

  :root {
    --bg:#060504;--bg-warm:#0d0a07;--gold:#d4b455;--gold-dim:#a89460;
    --gold-bright:#f0d464;--gold-pale:#ddd0a8;--red:#b84430;--red-soft:#9a5040;
    --parchment:#d4c5a0;--ink:#28200f;--teal:#5ab09e;--teal-dim:#4a8a7a;
    --blue:#6a9ac4;--blue-dim:#5a7a9a;--violet:#9a7aba;--violet-dim:#7a6a8a;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  html{background:#060504 !important;}
  body{background:#060504 !important;color:#d4b455;font-family:'Cormorant Garamond',serif;overflow-x:hidden;min-height:100vh;}

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav{position:fixed;top:0;left:0;right:0;z-index:1000;background:linear-gradient(180deg,rgba(6,5,4,.97)0%,rgba(6,5,4,.88)80%,transparent);padding:10px 0 18px;backdrop-filter:blur(8px);}
  .nav-inner{display:flex;align-items:center;justify-content:center;gap:clamp(4px,1.8vw,24px);padding:0 12px;flex-wrap:wrap;}
  .nav-brand{font-family:'Cinzel',serif;font-size:clamp(9px,1.2vw,14px);letter-spacing:.2em;color:#a89460;margin-right:clamp(2px,1vw,16px);white-space:nowrap;}
  .nav-tab{font-family:'EB Garamond',serif;font-size:clamp(10px,1.15vw,14px);color:#a89460;background:none;border:none;cursor:pointer;padding:3px 7px;letter-spacing:.05em;transition:color .4s;position:relative;white-space:nowrap;}
  .nav-tab::after{content:'';position:absolute;bottom:0;left:50%;width:0;height:1px;background:#d4b455;transition:width .4s,left .4s;}
  .nav-tab:hover{color:#ddd0a8;}
  .nav-tab.active{color:#d4b455;text-shadow:0 0 20px rgba(201,168,76,.2);}
  .nav-tab.active::after{width:100%;left:0;}
  .nav-num{font-family:'Cinzel',serif;font-size:.7em;margin-right:3px;opacity:.5;}

  /* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
  .page{display:none;min-height:100vh;padding-top:60px;opacity:0;transition:opacity .8s;background:#060504 !important;color:#d4b455;}
  .page.active{display:block;opacity:1;}
  .page-hdr{text-align:center;padding:clamp(24px,5vh,60px) 16px clamp(8px,2vh,20px);}
  .page-ttl{font-family:'Cinzel',serif;font-size:clamp(20px,3.5vw,44px);font-weight:600;letter-spacing:.12em;color:#d4b455;text-shadow:0 0 40px rgba(201,168,76,.12);}
  .page-sub{font-family:'EB Garamond',serif;font-size:clamp(12px,1.6vw,18px);font-style:italic;color:#a89460;margin-top:6px;letter-spacing:.04em;}
  .page-ln{width:clamp(50px,12vw,140px);height:1px;background:linear-gradient(90deg,transparent,#a89460,transparent);margin:12px auto;opacity:.4;}

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .cb{max-width:700px;margin:0 auto;padding:0 20px;}
  .prose{font-family:'EB Garamond',serif;font-size:clamp(14px,1.55vw,18px);line-height:1.75;color:#a89460;margin-bottom:20px;}
  .prose em{color:#ddd0a8;font-style:italic;} .prose strong{color:#d4b455;font-weight:500;}
  .qb{border-left:2px solid rgba(201,168,76,.2);padding:14px 20px;margin:24px 0;background:rgba(201,168,76,.02);border-radius:0 4px 4px 0;}
  .qt{font-family:'EB Garamond',serif;font-size:clamp(15px,1.7vw,20px);font-style:italic;color:#d4b455;line-height:1.7;}
  .qa{font-family:'Cormorant Garamond',serif;font-size:clamp(10px,1.1vw,13px);color:#a89460;margin-top:6px;opacity:.6;}
  .md{text-align:center;padding:20px 14px;margin:22px 0;font-family:'EB Garamond',serif;font-size:clamp(15px,2vw,24px);color:#d4b455;letter-spacing:.03em;text-shadow:0 0 20px rgba(201,168,76,.08);background:rgba(201,168,76,.012);border-radius:4px;border:1px solid rgba(201,168,76,.05);}
  .md-l{font-size:.6em;color:#a89460;font-style:italic;display:block;margin-top:5px;}

  /* ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ */
  .cc{position:relative;width:100%;max-width:900px;margin:20px auto;border-radius:5px;overflow:hidden;background:#060504;border:1px solid rgba(201,168,76,.07);}
  .cc canvas{width:100%;height:100%;display:block;}
  .cc-vig{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;background:radial-gradient(ellipse at center,transparent 50%,rgba(6,5,4,.45)100%);}
  .cc-label{position:absolute;top:8px;left:12px;font-family:'Cinzel',serif;font-size:clamp(9px,1vw,12px);letter-spacing:.12em;color:#a89460;opacity:.6;pointer-events:none;}

  /* aspect ratios */
  .ar169{aspect-ratio:16/9;}
  .ar2{aspect-ratio:2/1;}
  .ar32{aspect-ratio:3/2;}

  /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
  .ctrls{display:flex;flex-wrap:wrap;justify-content:center;gap:14px;padding:12px 16px;max-width:900px;margin:0 auto;}
  .cg{display:flex;flex-direction:column;align-items:center;gap:3px;}
  .cl{font-family:'EB Garamond',serif;font-size:clamp(9px,1vw,12px);color:#a89460;font-style:italic;}
  .cv{font-family:'EB Garamond',serif;font-size:clamp(12px,1.3vw,15px);color:#d4b455;min-width:36px;text-align:center;}
  input[type="range"]{-webkit-appearance:none;width:clamp(70px,10vw,140px);height:2px;background:rgba(201,168,76,.2);border-radius:2px;outline:none;}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:#d4b455;cursor:pointer;box-shadow:0 0 6px rgba(201,168,76,.3);}
  .btn{font-family:'Cinzel',serif;font-size:clamp(8px,.9vw,11px);letter-spacing:.16em;text-transform:uppercase;color:#a89460;background:none;border:1px solid rgba(201,168,76,.18);padding:7px 18px;cursor:pointer;transition:all .3s;border-radius:2px;}
  .btn:hover{color:#d4b455;border-color:#d4b455;box-shadow:0 0 14px rgba(201,168,76,.08);}

  /* ‚îÄ‚îÄ COMPARISON GRID ‚îÄ‚îÄ */
  .comp{display:grid;grid-template-columns:1fr 1fr;gap:1px;max-width:780px;margin:24px auto;border-radius:5px;overflow:hidden;border:1px solid rgba(201,168,76,.07);}
  .comp-h{font-family:'Cinzel',serif;font-size:clamp(11px,1.2vw,14px);letter-spacing:.1em;padding:11px 16px;text-align:center;}
  .comp-h.es{background:rgba(201,168,76,.05);color:#d4b455;} .comp-h.ps{background:rgba(80,65,40,.05);color:#a89460;}
  .comp-c{font-family:'EB Garamond',serif;font-size:clamp(11px,1.2vw,14px);padding:10px 14px;line-height:1.5;border-top:1px solid rgba(201,168,76,.03);}
  .comp-c.es{background:rgba(201,168,76,.015);color:#ddd0a8;} .comp-c.ps{background:rgba(6,5,4,.3);color:#a89460;}

  /* ‚îÄ‚îÄ PROTOCOL BOX ‚îÄ‚îÄ */
  .pb{max-width:580px;margin:24px auto;border:1px solid rgba(201,168,76,.1);border-radius:5px;overflow:hidden;background:rgba(201,168,76,.012);}
  .pb-t{font-family:'Cinzel',serif;font-size:clamp(10px,1.1vw,13px);letter-spacing:.14em;padding:10px 16px;background:rgba(201,168,76,.03);border-bottom:1px solid rgba(201,168,76,.06);text-align:center;}
  .pb-s{display:flex;gap:12px;padding:10px 16px;border-bottom:1px solid rgba(201,168,76,.02);align-items:flex-start;transition:background .5s;}
  .pb-s.hl{background:rgba(201,168,76,.05);}
  .pb-n{font-family:'Cinzel',serif;font-size:clamp(9px,.9vw,12px);color:#d4b455;opacity:.45;flex-shrink:0;padding-top:1px;}
  .pb-x{font-family:'EB Garamond',serif;font-size:clamp(12px,1.3vw,15px);color:#a89460;line-height:1.55;} .pb-x em{color:#ddd0a8;}
  .lib-box{max-width:540px;margin:28px auto 20px;text-align:center;padding:20px 28px 18px;border:1px solid rgba(201,168,76,.12);border-radius:4px;background:rgba(201,168,76,.015);}
  .lib-box .lib-label{font-family:'Cinzel',serif;font-size:clamp(8px,.85vw,10px);letter-spacing:.22em;color:rgba(168,148,96,.4);margin-bottom:10px;}
  .lib-box .lib-name{font-family:'Cinzel',serif;font-size:clamp(16px,2vw,24px);color:#d4b455;letter-spacing:.08em;margin-bottom:6px;}
  .lib-box .lib-desc{font-family:'EB Garamond',serif;font-size:clamp(13px,1.4vw,16px);color:#a89460;line-height:1.6;margin-bottom:14px;}
  .lib-box .lib-link{display:inline-block;font-family:'EB Garamond',serif;font-size:clamp(12px,1.2vw,14px);color:#d4b455;opacity:.55;text-decoration:none;border-bottom:1px solid rgba(212,180,85,.15);padding-bottom:1px;transition:opacity .3s,border-color .3s;}
  .lib-box .lib-link:hover{opacity:.85;border-color:rgba(212,180,85,.4);}

  /* ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ */
  .legend{display:flex;flex-wrap:wrap;justify-content:center;gap:16px;padding:8px 16px;max-width:900px;margin:0 auto;}
  .legend-item{display:flex;align-items:center;gap:6px;font-family:'EB Garamond',serif;font-size:clamp(11px,1.1vw,13px);color:#a89460;}
  .legend-dot{width:10px;height:3px;border-radius:1px;}

  /* ‚îÄ‚îÄ E-PROCESS OVERLAYS ‚îÄ‚îÄ */
  .ep-overlay{position:absolute;pointer-events:none;z-index:4;opacity:0;transition:opacity 2.2s ease;}
  .ep-overlay.vis{opacity:1;} .ep-overlay.out{opacity:0;transition:opacity 1.4s ease;}
  .ep-narr{font-family:'Cormorant Garamond',serif;font-size:clamp(13px,1.5vw,18px);font-weight:300;color:#a89460;font-style:italic;line-height:1.65;max-width:clamp(180px,22vw,280px);}
  .ep-narr em{color:#ddd0a8;font-style:italic;}
  .ep-narr-l{top:14%;left:4%;text-align:left;}
  .ep-narr-r{top:26%;right:4%;text-align:right;}
  .ep-verdict{top:6%;bottom:auto;left:50%;transform:translateX(-50%);text-align:center;max-width:clamp(260px,45vw,480px);}
  .ep-verdict .v-main{font-family:'EB Garamond',serif;font-size:clamp(15px,1.8vw,22px);color:#d4b455;font-style:italic;}
  .ep-verdict .v-sub{font-family:'EB Garamond',serif;font-size:clamp(11px,1.2vw,15px);color:#a89460;margin-top:4px;}
  .ep-verdict .v-note{font-family:'Cormorant Garamond',serif;font-size:clamp(10px,1vw,13px);color:rgba(168,148,96,.6);margin-top:6px;}
  .ep-eq{bottom:6%;top:auto;left:50%;transform:translateX(-50%);text-align:center;}
  .ep-eq .eq-desc{font-family:'EB Garamond',serif;font-size:clamp(12px,1.4vw,17px);color:#a89460;font-style:italic;}
  .ep-eq .eq-math{font-family:'EB Garamond',serif;font-size:clamp(15px,1.8vw,22px);color:#d4b455;margin:5px 0;letter-spacing:.03em;text-shadow:0 0 16px rgba(201,168,76,.1);}

  .section-spacer{height:clamp(16px,3vh,36px);}
  .pf{text-align:center;padding:32px 16px 24px;}
  .pf-t{font-family:'EB Garamond',serif;font-size:clamp(10px,1vw,12px);color:rgba(168,148,96,.45);font-style:italic;}

  ::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-track{background:#060504;} ::-webkit-scrollbar-thumb{background:rgba(201,168,76,.12);border-radius:2px;}

  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:900px;margin:16px auto;padding:0 16px;}
  @media(max-width:700px){.two-col{grid-template-columns:1fr;}}
</style>
</head>
<body>

<nav><div class="nav-inner">
  <div class="nav-brand">EVIDENCE</div>
  <button class="nav-tab active" data-page="intro"><span class="nav-num">I.</span>Prologue</button>
  <button class="nav-tab" data-page="evalue"><span class="nav-num">II.</span>E-Value</button>
  <button class="nav-tab" data-page="game"><span class="nav-num">III.</span>The Game</button>
  <button class="nav-tab" data-page="eprocess"><span class="nav-num">IV.</span>E-Process</button>
  <button class="nav-tab" data-page="betting"><span class="nav-num">V.</span>Betting</button>
  <button class="nav-tab" data-page="comparison"><span class="nav-num">VI.</span>E vs P</button>
  <button class="nav-tab" data-page="confseq"><span class="nav-num">VII.</span>Conf. Seq.</button>
  <button class="nav-tab" data-page="physics"><span class="nav-num">VIII.</span>Physics</button>
  <button class="nav-tab" data-page="finance"><span class="nav-num">IX.</span>Finance</button>
  <button class="nav-tab" data-page="neuro"><span class="nav-num">X.</span>Neuro</button>
</div></nav>

<!-- ‚ïê‚ïê‚ïê I. PROLOGUE ‚ïê‚ïê‚ïê -->
<section class="page active" id="page-intro">
  <div class="page-hdr"><div class="page-ttl">PROLOGUE</div><div class="page-ln"></div><div class="page-sub">On the nature of evidence</div></div>
  <div class="cb">
    <div class="qb"><div class="qt">Probabilities should not be assumed a priori.<br>A game should be assumed a priori.<br>The game forces you to play probabilistically.</div><div class="qa">‚Äî The foundational principle of game-theoretic probability</div></div>
    <p class="prose">For nearly a century, statistical inference has rested on <em>assumed probability measures</em>. We postulate that data comes from some distribution P, then derive tests and decisions from that assumption.</p>
    <p class="prose">But what if the <em>structure of the decision problem itself</em>, a game between a Skeptic who seeks truth and a Nature that reveals data, were enough to give rise to all of probability?</p>
    <p class="prose">This is the insight behind <strong>e-values</strong> and <strong>game-theoretic probability</strong>. An e-value is not a probability. It is a <em>bet</em>. It is the wealth of a gambler who wagered against the null hypothesis. When that wealth grows large, the evidence is strong, not because we computed a probability, but because the game would not allow it otherwise.</p>
  </div>
  <div class="lib-box">
    <div class="lib-label">EDUCATIONAL COMPANION TO</div>
    <div class="lib-name">expectation</div>
    <div class="lib-desc">A Python library for sequential testing with e-values, e-processes, confidence sequences, and game-theoretic probability.</div>
    <a class="lib-link" href="https://github.com/jakorostami/expectation" target="_blank" rel="noopener">github.com/jakorostami/expectation</a>
  </div>
  <div class="cc ar169" id="prologue-wrap"><canvas id="c-prologue"></canvas><div class="cc-vig"></div></div>
  <div class="pf"><div class="pf-t">Based on "Hypothesis Testing with E-values" ‚Äî Ramdas &amp; Wang (2025)</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê II. E-VALUE ‚ïê‚ïê‚ïê -->
<section class="page" id="page-evalue">
  <div class="page-hdr"><div class="page-ttl">THE E-VALUE</div><div class="page-ln"></div><div class="page-sub">Evidence as a wager</div></div>
  <div class="cb">
    <p class="prose">Imagine <strong>Forecaster</strong> claims hypothesis P is true. <strong>Skeptic</strong> pays $1 and specifies a bet E. If outcome œâ is observed, Skeptic gets E(œâ) back. The contract is fair to Forecaster when:</p>
    <div class="md">ùîº<sub>P</sub>[ E ] ‚â§ 1<span class="md-l">Under the null, Skeptic cannot expect to profit.</span></div>
  </div>
  <div class="cc ar2" id="evalue-wrap"><canvas id="c-evalue"></canvas><div class="cc-vig"></div></div>
  <div class="ctrls">
    <div class="cg"><div class="cl">Observed e-value</div><input type="range" id="ev-sl" min="0" max="50" step=".5" value="1"><div class="cv" id="ev-disp">1.0</div></div>
  </div>
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose">Below: the <em>distribution</em> of e-values under two worlds. Under the null (left), e-values scatter around 1 ‚Äî Skeptic breaks even on average. Under the alternative (right), e-values shift upward ‚Äî Skeptic profits because truth is on her side.</p>
  </div>
  <div class="cc ar2" id="evdist-wrap"><canvas id="c-evdist"></canvas><div class="cc-vig"></div><div class="cc-label">E-VALUE DISTRIBUTION: NULL vs ALTERNATIVE</div></div>
  <div class="ctrls"><button class="btn" onclick="runEVDist()">Sample 500 E-values</button></div>
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose">The simplest e-variable is the <strong>likelihood ratio</strong> ‚Äî the log-optimal bet, which maximizes expected wealth growth:</p>
    <div class="md">E = exp(Œº ¬∑ x ‚àí Œº¬≤/2)<span class="md-l">The Kelly-optimal wager for testing N(0,1) vs N(Œº,1).</span></div>
  </div>
  <div class="pf"><div class="pf-t">Section 1.5 ‚Äî Betting interpretation of e-values</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê III. THE GAME ‚ïê‚ïê‚ïê -->
<section class="page" id="page-game">
  <div class="page-hdr"><div class="page-ttl">THE GAME</div><div class="page-ln"></div><div class="page-sub">A protocol between Skeptic and Nature</div></div>
  <div class="cb"><p class="prose">Testing a hypothesis as a sequential game. At each round, Skeptic declares a bet <em>before</em> seeing the data. Nature reveals the outcome. Wealth grows or shrinks.</p></div>
  <div class="pb">
    <div class="pb-t">ALGORITHM ¬∑ TESTING BY BETTING</div>
    <div class="pb-s" id="gs0"><div class="pb-n">0.</div><div class="pb-x"><em>Skeptic's initial wealth is W‚ÇÄ = 1</em></div></div>
    <div class="pb-s" id="gs1"><div class="pb-n">1.</div><div class="pb-x">for t = 1, 2, 3, ‚Ä¶ do:</div></div>
    <div class="pb-s" id="gs2"><div class="pb-n">2.</div><div class="pb-x">Skeptic declares bet S<sub>t</sub> such that <em>ùîº<sub>P</sub>[S<sub>t</sub> | past] ‚â§ 1</em></div></div>
    <div class="pb-s" id="gs3"><div class="pb-n">3.</div><div class="pb-x">Nature reveals X<sub>t</sub></div></div>
    <div class="pb-s" id="gs4"><div class="pb-n">4.</div><div class="pb-x">W<sub>t</sub> = W<sub>t‚àí1</sub> ¬∑ S<sub>t</sub>(X<sub>t</sub>)</div></div>
  </div>
  <div class="cc ar169" id="game-wrap"><canvas id="c-game"></canvas><div class="cc-vig"></div><div class="cc-label">ABSTRACT GAME</div></div>
  <div class="ctrls">
    <button class="btn" onclick="runGame('abstract')">Play</button>
    <div class="cg"><div class="cl">True mean</div><input type="range" id="gm-mu" min="-.5" max="1.5" step=".05" value=".5"><div class="cv" id="gm-mu-d">0.50</div></div>
  </div>
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose">The same protocol applies in every domain. Here are two real-world applications of the testing-by-betting game:</p>
  </div>
  <div class="two-col">
    <div>
      <div class="cc ar32" id="neuro-wrap"><canvas id="c-neuro"></canvas><div class="cc-vig"></div><div class="cc-label">NEUROIMAGING ¬∑ VOXEL ACTIVATION</div></div>
      <div class="ctrls"><button class="btn" onclick="runGame('neuro')">Test Voxel</button></div>
      <div class="cb"><p class="prose" style="font-size:clamp(12px,1.3vw,15px);">Sequential monitoring of BOLD signal in a single brain voxel. Each fMRI volume provides one observation. The e-process accumulates evidence of activation <em>without</em> pre-specifying how many scans to collect.</p></div>
    </div>
    <div>
      <div class="cc ar32" id="ab-wrap"><canvas id="c-ab"></canvas><div class="cc-vig"></div><div class="cc-label">A/B TESTING ¬∑ CONVERSION RATE</div></div>
      <div class="ctrls"><button class="btn" onclick="runGame('ab')">Run Test</button></div>
      <div class="cb"><p class="prose" style="font-size:clamp(12px,1.3vw,15px);">Sequential comparison of two conversion rates. Each visitor provides a Bernoulli observation. Peek at the result after every user ‚Äî the e-process remains valid. <em>No need to wait for a fixed sample size.</em></p></div>
    </div>
  </div>
  <div class="pf"><div class="pf-t">Section 7.6 ‚Äî Testing by betting ¬∑ Algorithm 7.16</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê IV. E-PROCESS ‚ïê‚ïê‚ïê -->
<section class="page" id="page-eprocess">
  <div class="page-hdr"><div class="page-ttl">THE E-PROCESS</div><div class="page-ln"></div><div class="page-sub">Evidence accumulating through time</div></div>
  <div class="cb">
    <p class="prose">An e-process remains valid at <em>any stopping time</em>. You may peek whenever you wish and the conclusion holds. This is the gift of Ville's inequality.</p>
    <div class="md">P( sup<sub>t</sub> M<sub>t</sub> ‚â• 1/Œ± ) ‚â§ Œ±<span class="md-l">For any nonnegative supermartingale ‚Äî valid at all times simultaneously.</span></div>
  </div>
  <div class="cc ar169" id="ep-wrap" style="position:relative;">
    <canvas id="c-ep"></canvas><div class="cc-vig"></div>
    <div class="ep-overlay ep-narr ep-narr-l" id="ep-nl">Each observation is a round<br>in a game against Nature.<br><br><em>Skeptic places a bet ‚Äî constrained<br>so that under the null, no strategy<br>can systematically profit.</em></div>
    <div class="ep-overlay ep-narr ep-narr-r" id="ep-nr">But if the alternative is true,<br>wealth grows ‚Äî evidence accumulates<br>like light gathering in a lens.<br><br><em>No probability was assumed.<br>The game was assumed.<br>The game forced the probability.</em></div>
    <div class="ep-overlay ep-eq" id="ep-eq">
      <div class="eq-desc">The wealth of Skeptic, who bets against Nature</div>
      <div class="eq-math">W‚ÇÄ = 1 &nbsp;¬∑&nbsp; W‚Çú = W‚Çú‚Çã‚ÇÅ ¬∑ S‚Çú(X‚Çú)</div>
      <div class="eq-desc">grows only when truth is on her side.</div>
    </div>
    <div class="ep-overlay ep-verdict" id="ep-vd">
      <div class="v-main">The evidence has spoken.</div>
      <div class="v-sub">Skeptic's wealth crosses 1/Œ± ‚Äî the null is rejected.</div>
      <div class="v-note">By Ville's inequality, this could not happen by chance alone.</div>
    </div>
  </div>
  <div class="ctrls"><button class="btn" onclick="initEP()">Witness Again</button></div>
  <div class="pf"><div class="pf-t">Chapter 7 ‚Äî Sequential e-values and e-processes</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê V. BETTING STRATEGIES ‚ïê‚ïê‚ïê -->
<section class="page" id="page-betting">
  <div class="page-hdr"><div class="page-ttl">BETTING STRATEGIES</div><div class="page-ln"></div><div class="page-sub">How to wager against the null</div></div>
  <div class="cb">
    <p class="prose">The e-process framework offers freedom: <em>how much</em> of your wealth to bet on each round. The betting fraction Œª<sub>t</sub> can be chosen differently, yielding different growth-risk profiles. Four canonical strategies:</p>
    <p class="prose"><strong>All-In</strong> (Œª=1): Bet everything every round. Maximum growth when right, maximum volatility. The product of raw e-values.</p>
    <p class="prose"><strong>Conservative</strong> (Œª fixed, small): Steady, predictable growth. Lower variance, slower accumulation. Good when you need robustness.</p>
    <p class="prose"><strong>Empirically Adaptive</strong>: Start cautious (Œª‚ÇÅ=0), then learn the optimal fraction from past e-values. Asymptotically log-optimal without knowing the alternative.</p>
    <p class="prose"><strong>Log-Optimal</strong>: If you know the alternative Q, bet the Kelly fraction. Maximizes ùîº<sub>Q</sub>[log W<sub>t</sub>]. The gold standard, rarely achievable in practice.</p>
  </div>
  <div class="cc ar169" id="bet-wrap"><canvas id="c-bet"></canvas><div class="cc-vig"></div></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#e8c95a;"></div>All-In</div>
    <div class="legend-item"><div class="legend-dot" style="background:#4a9a8a;"></div>Conservative (Œª=0.3)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#5a8ab4;"></div>Empirically Adaptive</div>
    <div class="legend-item"><div class="legend-dot" style="background:#8a6aaa;"></div>Log-Optimal (oracle)</div>
  </div>
  <div class="ctrls">
    <button class="btn" onclick="initBetting()">Race Again</button>
    <div class="cg"><div class="cl">True effect size</div><input type="range" id="bt-mu" min="0" max="1" step=".05" value=".4"><div class="cv" id="bt-mu-d">0.40</div></div>
  </div>
  <div class="pf"><div class="pf-t">Definition 7.21 ‚Äî Betting strategies for e-processes</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê VI. E vs P ‚ïê‚ïê‚ïê -->
<section class="page" id="page-comparison">
  <div class="page-hdr"><div class="page-ttl">E VERSUS P</div><div class="page-ln"></div><div class="page-sub">Two philosophies of evidence</div></div>
  <div class="comp">
    <div class="comp-h es">E-VALUE</div><div class="comp-h ps">P-VALUE</div>
    <div class="comp-c es">A bet ‚Äî Skeptic's realized wealth</div><div class="comp-c ps">A tail probability under the null</div>
    <div class="comp-c es">Valid at <em>any</em> stopping time</div><div class="comp-c ps">Valid only at pre-specified n</div>
    <div class="comp-c es">Multiply to combine independent evidence</div><div class="comp-c ps">Cannot be multiplied directly</div>
    <div class="comp-c es">Average under <em>arbitrary dependence</em></div><div class="comp-c ps">Combining requires extra assumptions</div>
    <div class="comp-c es">Markov: P(E ‚â• 1/Œ±) ‚â§ Œ±. Always.</div><div class="comp-c ps">Requires distributional assumptions</div>
  </div>
  <div class="cc ar169" id="cmp-wrap"><canvas id="c-cmp"></canvas><div class="cc-vig"></div></div>
  <div class="ctrls">
    <button class="btn" onclick="initCmp()">Run Comparison</button>
    <div class="cg"><div class="cl">True effect</div><input type="range" id="cm-ef" min="0" max="1" step=".05" value=".3"><div class="cv" id="cm-ef-d">0.30</div></div>
  </div>
  <div class="cb"><div class="section-spacer"></div>
    <div class="qb"><div class="qt">An e-variable is genuinely a valid bet, but one over a p-variable is not ‚Äî the latter is effectively "double dipping."</div><div class="qa">‚Äî Ramdas &amp; Wang, Section 1.5</div></div>
  </div>
  <div class="pf"><div class="pf-t">Section 2.3 ‚Äî Calibrators ¬∑ Section 1.5 ‚Äî Betting interpretation</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê VII. CONFIDENCE SEQUENCES ‚ïê‚ïê‚ïê -->
<section class="page" id="page-confseq">
  <div class="page-hdr"><div class="page-ttl">CONFIDENCE SEQUENCES</div><div class="page-ln"></div><div class="page-sub">The dual face of the e-process</div></div>
  <div class="cb">
    <p class="prose">Every e-process has a dual: a <strong>confidence sequence</strong> ‚Äî an interval containing the true parameter at <em>every time step simultaneously</em>.</p>
    <div class="md">P( ‚àÄ t ‚â• 1 : Œº ‚àà C<sub>t</sub> ) ‚â• 1 ‚àí Œ±<span class="md-l">A confidence interval is a photograph. A confidence sequence is a film.</span></div>
    <p class="prose">It starts wide (little data, much uncertainty), then tightens as evidence accumulates, but <em>never loses its guarantee</em>. Stop collecting data whenever the interval is narrow enough for your purpose.</p>
  </div>
  <div class="cc ar169" id="cs-wrap"><canvas id="c-cs"></canvas><div class="cc-vig"></div></div>
  <div class="ctrls">
    <button class="btn" onclick="initCS()">Run Sequence</button>
    <div class="cg"><div class="cl">True mean Œº</div><input type="range" id="cs-mu" min="-1" max="2" step=".1" value=".5"><div class="cv" id="cs-mu-d">0.50</div></div>
    <div class="cg"><div class="cl">Level (1‚àíŒ±)</div><input type="range" id="cs-al" min=".01" max=".2" step=".01" value=".05"><div class="cv" id="cs-al-d">95%</div></div>
  </div>
  <div class="pf"><div class="pf-t">Howard, Ramdas, McAuliffe &amp; Sekhon (2021) ‚Äî Time-uniform confidence sequences</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê VIII. PHYSICS ‚ïê‚ïê‚ïê -->
<section class="page" id="page-physics">
  <div class="page-hdr"><div class="page-ttl">PHYSICS</div><div class="page-ln"></div><div class="page-sub">Evidence in the fundamental sciences</div></div>
  <div class="cb">
    <div class="qb"><div class="qt">In particle physics, discoveries are declared at "5 sigma." But sigma is a fixed-sample concept. An e-process lets us monitor the detector continuously ‚Äî accumulating evidence as each collision arrives.</div><div class="qa">‚Äî The sequential paradigm applied to experimental physics</div></div>
    <p class="prose">The connection between e-processes and physics runs deep. In particle physics, sequential monitoring of collision data yields an e-process that accumulates evidence for new particles ‚Äî the Poisson likelihood ratio is a natural e-value. And the <code>TwoSidedNormalMixture</code> from martingales.py provides the core machinery for testing any sequential stream of observations: a mixture supermartingale that simultaneously gives an e-process and a time-uniform confidence sequence.</p>
  </div>

  <!-- PARTICLE DETECTION -->
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose"><strong>Particle Discovery at a Collider.</strong> A detector counts events in successive time windows. Under background only (null), counts follow Poisson(Œª‚ÇÄ). If a new particle exists (alternative), counts follow Poisson(Œª‚ÇÅ &gt; Œª‚ÇÄ). Each window yields an e-value ‚Äî the likelihood ratio. The product e-process accumulates evidence collision by collision.</p>
    <div class="md">E<sub>t</sub> = (Œª‚ÇÅ/Œª‚ÇÄ)<sup>X<sub>t</sub></sup> ¬∑ exp(Œª‚ÇÄ ‚àí Œª‚ÇÅ)<span class="md-l">Poisson likelihood ratio ‚Äî the optimal bet for counting experiments.</span></div>
  </div>
  <div class="cc ar169" id="particle-wrap"><canvas id="c-particle"></canvas><div class="cc-vig"></div><div class="cc-label">PARTICLE COLLIDER ¬∑ SEQUENTIAL DISCOVERY</div></div>
  <div class="ctrls">
    <button class="btn" onclick="initParticle()">New Experiment</button>
    <div class="cg"><div class="cl">Signal strength</div><input type="range" id="ph-sig" min="0" max="5" step=".25" value="2"><div class="cv" id="ph-sig-d">2.0</div></div>
    <div class="cg"><div class="cl">Background rate</div><input type="range" id="ph-bg" min="1" max="10" step=".5" value="5"><div class="cv" id="ph-bg-d">5.0</div></div>
  </div>

  <!-- SEQUENTIAL MEAN TEST (TwoSidedNormalMixture from martingales.py) -->
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose"><strong>Sequential Mean Testing.</strong> The core of the library: testing whether a stream of observations has mean zero. The <code>TwoSidedNormalMixture</code> class (martingales.py) constructs a mixture supermartingale that yields both an e-process and a time-uniform confidence sequence. Under the null (Œº = 0), the wealth fluctuates near 1. Under drift Œº &gt; 0, the running mean escapes the shrinking confidence band and the e-process grows ‚Äî evidence accumulates proportional to Œº¬≤.</p>
    <div class="md">log M(S, v) = ¬Ω log( œÅ / (v + œÅ) ) + S¬≤ / ( 2(v + œÅ) )<span class="md-l">TwoSidedNormalMixture.log_superMG ‚Äî with œÅ = best_rho(v_opt, Œ±).</span></div>
  </div>
  <div class="cc ar169" id="meantest-wrap"><canvas id="c-meantest"></canvas><div class="cc-vig"></div><div class="cc-label">SEQUENTIAL MEAN TEST ¬∑ CONFIDENCE SEQUENCE</div></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:rgba(168,148,96,.6);"></div>Running mean XÃÑ<sub>t</sub></div>
    <div class="legend-item"><div class="legend-dot" style="background:rgba(90,176,158,.25);border:1px solid rgba(90,176,158,.4);"></div>Confidence band (CS)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#e8c95a;"></div>E-process wealth M<sub>t</sub></div>
  </div>
  <div class="ctrls">
    <button class="btn" onclick="initMeanTest()">New Sample</button>
    <div class="cg"><div class="cl">True Œº</div><input type="range" id="mt-mu" min="0" max="1" step=".05" value=".3"><div class="cv" id="mt-mu-d">0.30</div></div>
    <div class="cg"><div class="cl">Œ±</div><input type="range" id="mt-al" min=".01" max=".2" step=".01" value=".05"><div class="cv" id="mt-al-d">0.05</div></div>
  </div>
  <div class="pf"><div class="pf-t">TwoSidedNormalMixture (martingales.py) ¬∑ Confidence sequences (Howard, Ramdas, McAuliffe, Sekhon 2022)</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê IX. FINANCE ‚ïê‚ïê‚ïê -->
<section class="page" id="page-finance">
  <div class="page-hdr"><div class="page-ttl">FINANCE</div><div class="page-ln"></div><div class="page-sub">Backtesting, risk, and regime detection</div></div>
  <div class="cb">
    <div class="qb"><div class="qt">A firm may have incentive to forecast risk arbitrarily, but forecasting a larger risk results in financial cost. A backtest e-statistic rewards prudence ‚Äî overestimation of risk passes the test, underestimation is caught.</div><div class="qa">‚Äî Chapter 16 ¬∑ E-statistics for risk measures</div></div>
    <p class="prose">Game-theoretic probability was born, in part, from the study of financial markets. Shafer and Vovk's foundational work placed finance on game-theoretic footing: the market is Nature, the trader is Skeptic, and the absence of arbitrage is mathematically equivalent to the existence of a probability measure.</p>
  </div>

  <!-- VaR BACKTESTING -->
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose"><strong>VaR Backtesting.</strong> A bank reports daily Value-at-Risk: the loss threshold it claims will be exceeded only 1% of the time. The backtest e-statistic (Example 16.9) is e<sup>q</sup><sub>Œ≤</sub>(x, r) = ùüô{x &gt; r} / (1‚àíŒ≤) ‚Äî a simple indicator that equals 1/Œ± on exceedance days and 0 otherwise. These sequential e-values are combined into an e-process via the betting fraction approach (Equation 16.15, <code>EProcessUpdater</code>): M<sub>t</sub> = M<sub>t‚àí1</sub> ¬∑ ((1‚àíŒª) + ŒªE<sub>t</sub>). If the bank's model is honest, the e-process stays bounded. If risk is underestimated, evidence accumulates.</p>
    <div class="md">E<sub>t</sub> = ùüô{L<sub>t</sub> &gt; VaR<sub>t</sub>} / Œ±<span class="md-l">Exceedance indicator divided by the claimed probability ‚Äî a backtest e-statistic (Ex. 16.9).</span></div>
  </div>
  <div class="cc ar169" id="var-wrap"><canvas id="c-var"></canvas><div class="cc-vig"></div><div class="cc-label">VaR BACKTESTING ¬∑ REGULATORY MONITORING</div></div>
  <div class="ctrls">
    <button class="btn" onclick="initVaR()">New Backtest</button>
    <div class="cg"><div class="cl">Model quality</div><input type="range" id="vr-q" min="0" max="1" step=".05" value=".4"><div class="cv" id="vr-q-d">Poor</div></div>
  </div>

  <!-- REGIME DETECTION -->
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose"><strong>Market Regime Detection.</strong> Financial markets alternate between calm and turbulent regimes. The <code>ConformalCUSUM</code> class (cusum.py) implements a multiplicative e-detector: each observation yields an e-statistic e(x,r) = x¬≤/œÉ‚ÇÄ¬≤ for variance (Example 16.8), and the detector accumulates C<sub>t</sub> = max(C<sub>t-1</sub> ¬∑ E<sub>t</sub>, Œµ) with truncation floor Œµ = 10‚Åª¬π‚Å∞. Under the null (œÉ = œÉ‚ÇÄ), E[log E<sub>t</sub>] ‚âà ‚àí1.27, so the detector decays rapidly to near-zero. Under a volatility shift, it grows and triggers an alarm at threshold (default 20), then resets to 0.</p>
    <div class="md">C<sub>t</sub> = max( C<sub>t‚àí1</sub> ¬∑ E<sub>t</sub> , Œµ )<span class="md-l">ConformalCUSUM e-detector (cusum.py): truncation floor Œµ = 10‚Åª¬π‚Å∞, reset to 0 after alarm at threshold.</span></div>
  </div>
  <div class="cc ar169" id="regime-wrap"><canvas id="c-regime"></canvas><div class="cc-vig"></div><div class="cc-label">MARKET REGIME ¬∑ CUSUM E-DETECTOR</div></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:rgba(168,148,96,.5);"></div>Returns</div>
    <div class="legend-item"><div class="legend-dot" style="background:#e8c95a;"></div>CUSUM E-Detector</div>
    <div class="legend-item"><div class="legend-dot" style="background:rgba(184,68,48,.4);"></div>Regime shift</div>
    <div class="legend-item"><div class="legend-dot" style="background:#5ab09e;"></div>Alarm</div>
  </div>
  <div class="ctrls">
    <button class="btn" onclick="initRegime()">New Market</button>
    <div class="cg"><div class="cl">Volatility ratio</div><input type="range" id="rg-vr" min="1.5" max="5" step=".25" value="2.5"><div class="cv" id="rg-vr-d">2.5√ó</div></div>
  </div>
  <div class="pf"><div class="pf-t">Shafer &amp; Vovk (2019) ¬∑ Chapter 16 ‚Äî E-statistics for risk measures ¬∑ E-detectors (Shin, Ramdas &amp; Rinaldo, 2024)</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê X. NEUROSCIENCE ‚ïê‚ïê‚ïê -->
<section class="page" id="page-neuro">
  <div class="page-hdr"><div class="page-ttl">NEUROSCIENCE</div><div class="page-ln"></div><div class="page-sub">Massively parallel sequential testing</div></div>
  <div class="cb">
    <div class="qb"><div class="qt">An fMRI scan tests tens of thousands of voxels simultaneously. Classical methods must correct for all comparisons at once. With e-values, each voxel runs its own sequential test ‚Äî and the e-BH procedure controls false discovery rate at any stopping time, under arbitrary dependence.</div><div class="qa">‚Äî Chapter 9 ¬∑ The e-BH procedure for FDR control</div></div>
    <p class="prose">A brain scan divides the cortex into a lattice of volumetric pixels ‚Äî <em>voxels</em>. Each voxel produces a noisy time series of BOLD signal. The question at every voxel: is there neural activation above baseline? This is a <strong>massively parallel</strong> sequential testing problem. Each voxel runs an independent <code>TwoSidedNormalMixture</code> e-process (martingales.py). The e-BH procedure (Definition 9.8) then selects discoveries: reject all voxels whose e-process exceeds K/(Œ± ¬∑ |D|), controlling FDR at level Œ± under arbitrary dependence between voxels.</p>
    <div class="md">k* = max{ k : k ¬∑ E<sub>[k]</sub> / K ‚â• 1/Œ± }<span class="md-l">e-BH discovery threshold ‚Äî Theorem 9.11 guarantees FDR ‚â§ Œ± for any compound e-variables.</span></div>
  </div>

  <!-- BRAIN HEATMAP -->
  <div class="cb"><div class="section-spacer"></div>
    <p class="prose"><strong>Live Cortical Mapping.</strong> A top-down view of the cortex. Each cell is one voxel ‚Äî a region of interest being tested in parallel. As fMRI volumes arrive, evidence accumulates. Cool regions show no activation (e-process near 1). Warm regions show growing evidence. When a voxel's e-process crosses 1/Œ±, it lights up ‚Äî a discovery. The scan progress bar shows acquisition time, and the counter tracks discoveries in real time.</p>
  </div>
  <div class="cc" id="brain-wrap" style="aspect-ratio:16/10;"><canvas id="c-brain"></canvas><div class="cc-vig"></div><div class="cc-label">CORTICAL HEATMAP ¬∑ SEQUENTIAL EVIDENCE ACCUMULATION</div></div>

  <div class="cb"><div class="section-spacer"></div>
    <p class="prose"><strong>Voxel Signals.</strong> Below, each ribbon is a single voxel's BOLD signal over time. Most voxels are null ‚Äî pure noise around zero. A subset carry true activation (a small positive drift). The 3D view reveals the spatial structure: many parallel streams of evidence, tested simultaneously.</p>
  </div>
  <div class="cc" id="neuro-sig-wrap" style="aspect-ratio:16/9;"><canvas id="c-neuro-sig"></canvas><div class="cc-vig"></div><div class="cc-label">VOXEL SIGNALS ¬∑ 3D TRAJECTORY FIELD</div></div>

  <div class="cb"><div class="section-spacer"></div>
    <p class="prose"><strong>Parallel E-Processes.</strong> Each voxel's signal feeds a <code>TwoSidedNormalMixture</code> supermartingale. Under the null, wealth stays near 1. Under activation, it grows ‚Äî the active voxels rise from the field like peaks on a landscape. The e-BH threshold adapts to the number of discoveries, controlling false discovery rate across all voxels simultaneously.</p>
  </div>
  <div class="cc" id="neuro-ep-wrap" style="aspect-ratio:16/9;"><canvas id="c-neuro-ep"></canvas><div class="cc-vig"></div><div class="cc-label">PARALLEL E-PROCESSES ¬∑ MIXTURE SUPERMARTINGALES</div></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:rgba(168,148,96,.25);"></div>Null voxels (no activation)</div>
    <div class="legend-item"><div class="legend-dot" style="background:rgba(90,176,158,.7);"></div>Active voxels (true signal)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#e8c95a;"></div>Discoveries (e-BH rejections)</div>
  </div>
  <div class="ctrls">
    <button class="btn" onclick="initNeuro()">New Brain</button>
    <div class="cg"><div class="cl">Active %</div><input type="range" id="nr-act" min="5" max="40" step="5" value="20"><div class="cv" id="nr-act-d">20%</div></div>
    <div class="cg"><div class="cl">Effect Œº</div><input type="range" id="nr-mu" min=".1" max=".8" step=".05" value=".35"><div class="cv" id="nr-mu-d">0.35</div></div>
  </div>
  <div class="pf"><div class="pf-t">TwoSidedNormalMixture (martingales.py) ¬∑ e-BH procedure (Chapter 9, Theorem 9.11) ¬∑ Compound e-values</div></div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
const G=()=>{let u=0,v=0;while(!u)u=Math.random();while(!v)v=Math.random();return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);};
const R=(r,g,b,a)=>`rgba(${r},${g},${b},${a})`;
const eIO=t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;
const eO=t=>1-(1-t)*(1-t);
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const GOLD=[212,180,85],GD=[168,148,96],GB=[240,212,100],RED=[184,68,48],
      TEAL=[90,176,158],BLUE=[106,154,196],VIOL=[154,122,186],PARCH=[212,197,160],BG=[6,5,4];

function sCanvas(c){const d=window.devicePixelRatio||1,r=c.parentElement.getBoundingClientRect();c.width=r.width*d;c.height=r.height*d;const x=c.getContext('2d');x.setTransform(d,0,0,d,0,0);return{x,w:r.width,h:r.height};}
function glow(x,cx,cy,r,c,a){const g=x.createRadialGradient(cx,cy,0,cx,cy,r);g.addColorStop(0,R(c[0],c[1],c[2],a));g.addColorStop(.5,R(c[0],c[1],c[2],a*.3));g.addColorStop(1,R(c[0],c[1],c[2],0));x.fillStyle=g;x.beginPath();x.arc(cx,cy,r,0,Math.PI*2);x.fill();}
function nCDF(x){const a1=.254829592,a2=-.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=.3275911;const s=x<0?-1:1;x=Math.abs(x)/Math.sqrt(2);const t=1/(1+p*x);return .5*(1+s*(1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x)));}
function poisson(lam){let L=Math.exp(-lam),k=0,p=1;do{k++;p*=Math.random();}while(p>L);return k-1;}

const AF={};
function stopAF(k){if(AF[k]){cancelAnimationFrame(AF[k]);AF[k]=null;}}

// ‚îÄ‚îÄ CHART HELPER ‚îÄ‚îÄ
function drawAxes(x,mx,my,cw,ch,opts={}){
  x.strokeStyle=R(GD[0],GD[1],GD[2],.18);x.lineWidth=.5;
  x.beginPath();x.moveTo(mx,my+ch);x.lineTo(mx+cw,my+ch);x.stroke();
  x.beginPath();x.moveTo(mx,my);x.lineTo(mx,my+ch);x.stroke();
}
function drawThreshold(x,mx,my,cw,ch,yFrac,label,col){
  const py=my+ch*(1-yFrac);
  x.strokeStyle=R(col[0],col[1],col[2],.12);x.setLineDash([3,6]);x.lineWidth=.5;
  x.beginPath();x.moveTo(mx,py);x.lineTo(mx+cw,py);x.stroke();x.setLineDash([]);
  if(label){x.font=`${Math.max(8,cw*.013)}px 'EB Garamond',serif`;x.fillStyle=R(col[0],col[1],col[2],.3);x.textAlign='right';x.fillText(label,mx-5,py+3);}
  return py;
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
document.querySelectorAll('.nav-tab').forEach(t=>{
  t.addEventListener('click',()=>{
    const pg=t.dataset.page;
    Object.keys(AF).forEach(k=>stopAF(k));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
    document.getElementById('page-'+pg).classList.add('active');
    t.classList.add('active');
    window.scrollTo(0,0);
    setTimeout(()=>initPage(pg),80);
  });
});

function initPage(pg){
  if(pg==='intro')initPrologue();
  if(pg==='evalue')initEValue();
  if(pg==='game')initGamePage();
  if(pg==='eprocess')initEP();
  if(pg==='betting')initBetting();
  if(pg==='comparison')initCmp();
  if(pg==='confseq')initCS();
  if(pg==='physics')initPhysics();
  if(pg==='finance')initFinance();
  if(pg==='neuro')initNeuro();
}

// ‚îÄ‚îÄ I. PROLOGUE ‚îÄ‚îÄ
function initPrologue(){
  const c=document.getElementById('c-prologue');const{x,w,h}=sCanvas(c);
  let dust=Array.from({length:35},()=>({x:Math.random()*w,y:Math.random()*h,s:Math.random()*1.1+.3,sp:Math.random()*.08+.02,a:Math.random()*.18+.04,ph:Math.random()*Math.PI*2}));
  function d(t){
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    glow(x,w*.5,h*.45,w*.35,[25,18,10],.25);
    dust.forEach(p=>{p.y-=p.sp;p.x+=Math.sin(t*.0003+p.ph)*.04;if(p.y<-5){p.y=h+5;p.x=Math.random()*w;}x.fillStyle=R(PARCH[0],PARCH[1],PARCH[2],p.a*(.6+.4*Math.sin(t*.002+p.ph)));x.beginPath();x.arc(p.x,p.y,p.s,0,Math.PI*2);x.fill();});
    const pulse=.7+.3*Math.sin(t*.001);
    glow(x,w*.5,h*.5,55*pulse,GOLD,.06);
    x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.12*pulse);x.lineWidth=.5;
    for(let i=0;i<6;i++){x.save();x.translate(w*.5,h*.5);x.rotate(i*Math.PI/3+t*.0002);x.beginPath();x.moveTo(0,-25*pulse);x.lineTo(0,-60*pulse);x.stroke();x.restore();}
    x.font=`italic ${Math.max(12,w*.03)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.3*pulse);x.textAlign='center';x.fillText('ùîº‚Çö[ E ] ‚â§ 1',w*.5,h*.5+4);
    AF.intro=requestAnimationFrame(d);
  }
  stopAF('intro');AF.intro=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ II. E-VALUE ‚îÄ‚îÄ
function initEValue(){
  const c=document.getElementById('c-evalue');const{x,w,h}=sCanvas(c);
  const sl=document.getElementById('ev-sl'),dp=document.getElementById('ev-disp');
  function d(t){
    const ev=parseFloat(sl.value);dp.textContent=ev.toFixed(1);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    const bY=h*.5,maxE=50,lx=w*.08,rx=w*.92,bW=rx-lx;
    x.strokeStyle=R(GD[0],GD[1],GD[2],.18);x.lineWidth=1;x.beginPath();x.moveTo(lx,bY);x.lineTo(rx,bY);x.stroke();
    [0,1,5,10,20,50].forEach(v=>{const px=lx+(v/maxE)*bW;x.strokeStyle=R(GD[0],GD[1],GD[2],.12);x.beginPath();x.moveTo(px,bY-5);x.lineTo(px,bY+5);x.stroke();x.font=`${Math.max(9,w*.013)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.35);x.textAlign='center';x.fillText(v.toString(),px,bY+18);});
    const x1=lx+(1/maxE)*bW;
    x.strokeStyle=R(GD[0],GD[1],GD[2],.08);x.setLineDash([2,4]);x.beginPath();x.moveTo(x1,bY-h*.25);x.lineTo(x1,bY+24);x.stroke();x.setLineDash([]);
    x.font=`italic ${Math.max(9,w*.012)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.fillText('Break even',x1,bY-h*.25+12);
    const x20=lx+(20/maxE)*bW;
    x.strokeStyle=R(GB[0],GB[1],GB[2],.08);x.setLineDash([2,4]);x.beginPath();x.moveTo(x20,bY-h*.2);x.lineTo(x20,bY+24);x.stroke();x.setLineDash([]);
    x.font=`italic ${Math.max(9,w*.012)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.25);x.fillText('1/Œ± = 20',x20,bY-h*.2+12);
    const xE=lx+(clamp(ev,0,maxE)/maxE)*bW;
    const col=ev>1?GB:(ev<1?RED:GD);
    glow(x,xE,bY,18+clamp(ev,0,40)*1.2,col,.15+clamp(ev,0,20)*.008);
    x.fillStyle=R(col[0],col[1],col[2],.9);x.beginPath();x.arc(xE,bY,4.5,0,Math.PI*2);x.fill();
    const txt=ev>=1?`Skeptic holds $${ev.toFixed(1)}`:`Skeptic lost ‚Äî $${ev.toFixed(2)} remains`;
    x.font=`${Math.max(13,w*.025)}px 'EB Garamond',serif`;x.fillStyle=R(col[0],col[1],col[2],.65);x.textAlign='center';x.fillText(txt,w*.5,bY-35);
    if(ev>=20){x.font=`italic ${Math.max(11,w*.016)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.4);x.fillText('Reject at Œ± = 0.05',w*.5,bY+50);}
    AF.evalue=requestAnimationFrame(d);
  }
  stopAF('evalue');AF.evalue=requestAnimationFrame(d);
}

function runEVDist(){
  const c=document.getElementById('c-evdist');const{x,w,h}=sCanvas(c);
  const N=500,lam=.4,mu=.5;
  const nullE=[],altE=[];
  for(let i=0;i<N;i++){nullE.push(Math.exp(lam*G()-lam*lam/2));altE.push(Math.exp(lam*(mu+G())-lam*lam/2));}
  const bins=40,maxV=8;
  function hist(arr){const h=new Array(bins).fill(0);arr.forEach(v=>{const b=Math.floor(clamp(v,0,maxV-.01)/maxV*bins);h[b]++;});return h.map(v=>v/arr.length);}
  const hNull=hist(nullE),hAlt=hist(altE);
  const maxH=Math.max(...hNull,...hAlt)*1.2;
  let start=0;
  function d(t){
    if(!start)start=t;const el=t-start;const prog=Math.min(1,el/2500);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    const mx=w*.06,my=h*.12,cw=w*.88,ch=h*.72;
    const half=cw*.47,gap=cw*.06;
    x.font=`${Math.max(10,w*.013)}px 'Cinzel',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.45);x.textAlign='center';
    x.fillText('UNDER THE NULL',mx+half*.5,my-4);
    const drawBins=Math.floor(prog*bins);
    for(let i=0;i<drawBins;i++){
      const bx=mx+(i/bins)*half,bw=half/bins-1;
      const bh=hNull[i]/maxH*ch;
      x.fillStyle=R(GD[0],GD[1],GD[2],.35);x.fillRect(bx,my+ch-bh,bw,bh);
    }
    x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.45);
    x.fillText('UNDER THE ALTERNATIVE',mx+half+gap+half*.5,my-4);
    for(let i=0;i<drawBins;i++){
      const bx=mx+half+gap+(i/bins)*half,bw=half/bins-1;
      const bh=hAlt[i]/maxH*ch;
      x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.3);x.fillRect(bx,my+ch-bh,bw,bh);
    }
    x.strokeStyle=R(GD[0],GD[1],GD[2],.15);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx,my+ch);x.lineTo(mx+half,my+ch);x.stroke();
    x.beginPath();x.moveTo(mx+half+gap,my+ch);x.lineTo(mx+half*2+gap,my+ch);x.stroke();
    const e1x=mx+(1/maxV)*half;
    x.strokeStyle=R(GB[0],GB[1],GB[2],.15);x.setLineDash([2,3]);x.beginPath();x.moveTo(e1x,my);x.lineTo(e1x,my+ch);x.stroke();x.setLineDash([]);
    const e1x2=mx+half+gap+(1/maxV)*half;
    x.strokeStyle=R(GB[0],GB[1],GB[2],.15);x.setLineDash([2,3]);x.beginPath();x.moveTo(e1x2,my);x.lineTo(e1x2,my+ch);x.stroke();x.setLineDash([]);
    x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';
    x.fillText('E = 1',e1x,my+ch+14);x.fillText('E = 1',e1x2,my+ch+14);
    if(prog>.8){
      x.font=`italic ${Math.max(10,w*.012)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.25);x.textAlign='center';
      x.fillText('Centered around 1 ‚Äî no systematic profit',mx+half*.5,my+ch+28);
      x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.25);
      x.fillText('Shifted right ‚Äî Skeptic profits on average',mx+half+gap+half*.5,my+ch+28);
    }
    if(prog<1)AF.evdist=requestAnimationFrame(d);
  }
  stopAF('evdist');AF.evdist=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ III. GAME ‚îÄ‚îÄ
function initGamePage(){
  const c=document.getElementById('c-game');const{x,w,h}=sCanvas(c);
  x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);x.font=`italic ${Math.max(12,w*.02)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.25);x.textAlign='center';x.fillText('Press Play to begin',w*.5,h*.5);
  document.getElementById('gm-mu').oninput=function(){document.getElementById('gm-mu-d').textContent=parseFloat(this.value).toFixed(2);};
  ['c-neuro','c-ab'].forEach(id=>{const cc=document.getElementById(id);if(!cc)return;const{x:cx,w:cw,h:ch}=sCanvas(cc);cx.fillStyle=R(6,5,4,1);cx.fillRect(0,0,cw,ch);cx.font=`italic ${Math.max(11,cw*.025)}px 'EB Garamond',serif`;cx.fillStyle=R(GD[0],GD[1],GD[2],.2);cx.textAlign='center';cx.fillText('Press button to begin',cw*.5,ch*.5);});
}

function runGame(mode){
  let canvasId,N,mu,lam,xLabel,yLabel;
  if(mode==='abstract'){canvasId='c-game';N=80;mu=parseFloat(document.getElementById('gm-mu').value);lam=.35;xLabel='Observations';yLabel='W(t)';}
  else if(mode==='neuro'){canvasId='c-neuro';N=60;mu=.35;lam=.3;xLabel='fMRI Volumes';yLabel='Evidence';}
  else{canvasId='c-ab';N=60;mu=.12;lam=.5;xLabel='Visitors';yLabel='Evidence';}
  const vals=[1],es=[];
  for(let i=0;i<N;i++){
    const obs=mode==='ab'?((Math.random()<(.15+mu))?1:0)-((Math.random()<.15)?1:0):(mu+G());
    const e=Math.exp(lam*obs-lam*lam/2);es.push(e);vals.push(Math.max(vals[vals.length-1]*e,1e-4));
  }
  const c=document.getElementById(canvasId);const{x,w,h}=sCanvas(c);
  let start=0;
  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/10000),upTo=Math.floor(prog*N);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);glow(x,w*.5,h*.4,w*.3,[20,15,8],.15);
    const mx=w*.13,my=h*.14,cw=w*.78,ch=h*.66;
    const logV=vals.map(v=>Math.log10(Math.max(v,.001)));
    const logMax=Math.max(1.5,Math.max(...logV)*1.2);
    const logMin=Math.min(-.5,Math.min(...logV)*1.1);
    x.save();x.beginPath();x.rect(mx-2,my-2,cw+4,ch+4);x.clip();
    x.strokeStyle=R(GD[0],GD[1],GD[2],.18);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx,my+ch);x.lineTo(mx+cw,my+ch);x.stroke();
    x.beginPath();x.moveTo(mx,my);x.lineTo(mx,my+ch);x.stroke();
    const thLY=(Math.log10(20)-logMin)/(logMax-logMin);
    const thPx=my+ch*(1-thLY);
    x.strokeStyle=R(GB[0],GB[1],GB[2],.12);x.setLineDash([3,6]);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx,thPx);x.lineTo(mx+cw,thPx);x.stroke();x.setLineDash([]);
    const oneLY=(0-logMin)/(logMax-logMin);const onePx=my+ch*(1-oneLY);
    x.strokeStyle=R(GD[0],GD[1],GD[2],.06);x.setLineDash([2,4]);
    x.beginPath();x.moveTo(mx,onePx);x.lineTo(mx+cw,onePx);x.stroke();x.setLineDash([]);
    if(upTo>0){
      x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.8);x.lineWidth=1.8;x.lineJoin='round';
      x.beginPath();
      for(let i=0;i<=upTo;i++){const px=mx+(i/N)*cw;const ly=(logV[i]-logMin)/(logMax-logMin);const py=my+ch*(1-ly);if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}
      x.stroke();
      const hi=Math.min(upTo,N);const hx=mx+(hi/N)*cw;const hly=(logV[hi]-logMin)/(logMax-logMin);const hy=my+ch*(1-hly);
      glow(x,hx,hy,16,GB,.18);x.fillStyle=R(GB[0],GB[1],GB[2],.9);x.beginPath();x.arc(hx,hy,2.5,0,Math.PI*2);x.fill();
    }
    x.restore();
    x.save();x.translate(mx-22,my+ch*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.35);x.textAlign='center';x.fillText(yLabel,0,0);x.restore();
    x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.35);x.textAlign='center';x.fillText(xLabel,mx+cw*.5,my+ch+18);
    const thPxCl=clamp(thPx,my,my+ch);
    x.font=`${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.25);x.textAlign='right';x.fillText('1/Œ±',mx-5,thPxCl+3);
    if(upTo>0){x.font=`${Math.max(11,w*.016)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.5);x.textAlign='right';x.fillText(`W = ${vals[Math.min(upTo,N)].toFixed(2)}`,mx+cw,my+12);}
    if(prog<1)AF[mode]=requestAnimationFrame(d);
  }
  stopAF(mode);AF[mode]=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ IV. E-PROCESS ‚îÄ‚îÄ
function initEP(){
  const c=document.getElementById('c-ep');const{x,w,h}=sCanvas(c);
  const N=100,mu=.42,lam=.38;
  const vals=[1],es=[];
  for(let i=0;i<N;i++){const v=mu+G();const e=Math.exp(lam*v-lam*lam/2);es.push(e);vals.push(Math.max(vals[vals.length-1]*e,.001));}
  let dust=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,s:Math.random()*1+.3,sp:Math.random()*.1+.02,a:Math.random()*.15+.04,ph:Math.random()*Math.PI*2}));
  let start=0,crossIdx=-1;
  const olNL=document.getElementById('ep-nl'),olNR=document.getElementById('ep-nr'),olEQ=document.getElementById('ep-eq'),olVD=document.getElementById('ep-vd');
  [olNL,olNR,olEQ,olVD].forEach(el=>{if(el){el.classList.remove('vis','out');}});
  function d(t){
    if(!start)start=t;const el=t-start;
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);glow(x,w*.5,h*.4,w*.35,[22,16,8],.2);
    dust.forEach(p=>{p.y-=p.sp;p.x+=Math.sin(t*.0003+p.ph)*.04;if(p.y<-5){p.y=h+5;p.x=Math.random()*w;}x.fillStyle=R(PARCH[0],PARCH[1],PARCH[2],p.a*(.6+.4*Math.sin(t*.002+p.ph)));x.beginPath();x.arc(p.x,p.y,p.s,0,Math.PI*2);x.fill();});
    if(el<3500){
      const a=el<1800?eIO(el/1800):Math.max(0,1-eIO((el-2500)/1000));
      x.font=`600 ${Math.max(18,w*.045)}px 'Cinzel',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],a*.7);x.textAlign='center';x.fillText('THE E-PROCESS',w*.5,h*.44);
      x.font=`italic ${Math.max(11,w*.017)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],a*.45);x.fillText('A meditation on the accumulation of evidence',w*.5,h*.52);
      AF.eprocess=requestAnimationFrame(d);return;
    }
    const drawEl=el-3500,prog=Math.min(1,drawEl/20000),upTo=Math.floor(prog*N);
    const mx=w*.12,my=h*.14,cw=w*.78,ch=h*.66;
    const logV=vals.map(v=>Math.log10(Math.max(v,.001)));
    const logMax=Math.max(2,Math.max(...logV)*1.15);
    if(olEQ){if(drawEl>1800&&drawEl<17000){olEQ.classList.add('vis');olEQ.classList.remove('out');}if(drawEl>=17000&&!olEQ.classList.contains('out')){olEQ.classList.add('out');olEQ.classList.remove('vis');}}
    if(olNL){if(drawEl>3500&&drawEl<12000){olNL.classList.add('vis');olNL.classList.remove('out');}if(drawEl>=12000&&!olNL.classList.contains('out')){olNL.classList.add('out');olNL.classList.remove('vis');}}
    if(olNR){if(drawEl>7500&&drawEl<16000){olNR.classList.add('vis');olNR.classList.remove('out');}if(drawEl>=16000&&!olNR.classList.contains('out')){olNR.classList.add('out');olNR.classList.remove('vis');}}
    if(olVD&&crossIdx>0&&upTo>crossIdx+12){olVD.classList.add('vis');}
    x.save();x.beginPath();x.rect(mx-2,my-2,cw+4,ch+4);x.clip();
    const axP=Math.min(1,(drawEl-300)/1800);
    if(axP>0){const ae=eIO(axP);x.strokeStyle=R(GD[0],GD[1],GD[2],.18*ae);x.lineWidth=.5;x.beginPath();x.moveTo(mx,my+ch);x.lineTo(mx+cw*ae,my+ch);x.stroke();x.beginPath();x.moveTo(mx,my+ch);x.lineTo(mx,my+ch-ch*ae);x.stroke();}
    const thP=Math.min(1,(drawEl-2500)/1500);
    if(thP>0){const te=eIO(thP);const thY=my+ch*(1-Math.log10(20)/logMax);x.strokeStyle=R(GB[0],GB[1],GB[2],.15*te);x.setLineDash([3,6]);x.lineWidth=.5;x.beginPath();x.moveTo(mx,thY);x.lineTo(mx+cw*te,thY);x.stroke();x.setLineDash([]);}
    if(upTo>0){
      for(let i=Math.max(1,upTo-10);i<=upTo;i++){const px=mx+(i/N)*cw;const py=my+ch*(1-logV[i]/logMax);const age=(upTo-i)/10;glow(x,px,py,12,GOLD,.012*(1-age));}
      x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.85);x.lineWidth=2;x.lineJoin='round';x.lineCap='round';
      x.beginPath();for(let i=0;i<=upTo;i++){const px=mx+(i/N)*cw;const py=my+ch*(1-logV[i]/logMax);if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}x.stroke();
      const hi=upTo;const hx=mx+(hi/N)*cw,hy=my+ch*(1-logV[hi]/logMax);
      const pulse=.6+.4*Math.sin(t*.005);
      glow(x,hx,hy,22*pulse,GB,.22);x.fillStyle=R(GB[0],GB[1],GB[2],.9);x.beginPath();x.arc(hx,hy,2.5,0,Math.PI*2);x.fill();
      for(let i=Math.max(1,upTo-8);i<=upTo;i++){const px=mx+(i/N)*cw,py=my+ch*(1-logV[i]/logMax);const age=(upTo-i)/8;if(age<1){const col=es[i-1]>1.3?GB:(es[i-1]<.7?RED:GD);x.strokeStyle=R(col[0],col[1],col[2],(1-age)*.22);x.lineWidth=.5;x.beginPath();x.arc(px,py,(1-age)*12,0,Math.PI*2);x.stroke();}}
      if(crossIdx<0){for(let i=1;i<=upTo;i++){if(vals[i]>=20&&vals[i-1]<20){crossIdx=i;break;}}}
      if(crossIdx>0&&upTo>=crossIdx){
        const cx2=mx+(crossIdx/N)*cw,cy2=my+ch*(1-logV[crossIdx]/logMax);
        const vp=Math.min(1,(upTo-crossIdx)/15);
        if(vp>0){const ve=eIO(vp);x.strokeStyle=R(GB[0],GB[1],GB[2],(1-ve*.5)*.3);x.lineWidth=1;x.beginPath();x.arc(cx2,cy2,ve*70,0,Math.PI*2);x.stroke();if(vp>.2){const ve2=eIO((vp-.2)/.8);x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],(1-ve2)*.15);x.lineWidth=.6;x.beginPath();x.arc(cx2,cy2,ve2*120,0,Math.PI*2);x.stroke();}glow(x,cx2,cy2,40*ve,GB,.15);x.strokeStyle=R(GB[0],GB[1],GB[2],ve*.2);x.lineWidth=.5;x.setLineDash([2,4]);x.beginPath();x.moveTo(cx2,cy2);x.lineTo(cx2,my+ch);x.stroke();x.setLineDash([]);}
      }
    }
    x.restore();
    if(axP>.5){const la=eO((axP-.5)*2);x.save();x.translate(mx-22,my+ch*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.35*la);x.textAlign='center';x.fillText('W(t) ‚Äî Skeptic\'s Wealth',0,0);x.restore();x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.35*la);x.textAlign='center';x.fillText('Observations',mx+cw*.5,my+ch+18);}
    if(thP>.6){x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.3*(thP-.6)/.4);x.textAlign='left';x.fillText('1/Œ± ‚Äî threshold of conviction',mx+cw+6,my+ch*(1-Math.log10(20)/logMax)+3);}
    if(crossIdx>0&&upTo>=crossIdx){const cx2=mx+(crossIdx/N)*cw;const vp=Math.min(1,(upTo-crossIdx)/15);if(vp>.3){x.font=`${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],eO((vp-.3)/.7)*.5);x.textAlign='center';x.fillText(`œÑ = ${crossIdx}`,cx2,my+ch+13);}}
    AF.eprocess=requestAnimationFrame(d);
  }
  stopAF('eprocess');crossIdx=-1;start=0;AF.eprocess=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ V. BETTING STRATEGIES ‚îÄ‚îÄ
function initBetting(){
  document.getElementById('bt-mu').oninput=function(){document.getElementById('bt-mu-d').textContent=parseFloat(this.value).toFixed(2);};
  const c=document.getElementById('c-bet');const{x,w,h}=sCanvas(c);
  const mu=parseFloat(document.getElementById('bt-mu').value);
  const N=100,lam=.4;
  const evals=[];for(let i=0;i<N;i++){evals.push(Math.exp(lam*(mu+G())-lam*lam/2));}
  const allIn=[1];for(let i=0;i<N;i++)allIn.push(Math.max(allIn[allIn.length-1]*evals[i],.001));
  const consv=[1];for(let i=0;i<N;i++){consv.push(Math.max(consv[consv.length-1]*(.7+.3*evals[i]),.001));}
  const adapt=[1];let pastE=[];
  for(let i=0;i<N;i++){let lb=0;if(pastE.length>1){const mn=pastE.reduce((a,b)=>a+b,0)/pastE.length;if(mn>1){lb=Math.min(.6,Math.max(0,(mn-1)/mn));}}adapt.push(Math.max(adapt[adapt.length-1]*((1-lb)+lb*evals[i]),.001));pastE.push(evals[i]);}
  const optLam=clamp(mu,0,.8);
  const logOpt=[1];for(let i=0;i<N;i++){logOpt.push(Math.max(logOpt[logOpt.length-1]*((1-optLam)+optLam*evals[i]),.001));}
  const traces=[{v:allIn,c:GB,n:'All-In'},{v:consv,c:TEAL,n:'Conservative'},{v:adapt,c:BLUE,n:'Adaptive'},{v:logOpt,c:VIOL,n:'Log-Optimal'}];
  let start=0;
  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/14000),upTo=Math.floor(prog*N);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);glow(x,w*.5,h*.4,w*.3,[20,15,8],.12);
    const mx=w*.12,my=h*.12,cw=w*.78,ch=h*.7;
    const allV=traces.flatMap(tr=>tr.v.slice(0,upTo+1));
    const logAll=allV.map(v=>Math.log10(Math.max(v,.001)));
    const logMax=Math.max(2,Math.max(...logAll)*1.15);const logMin=Math.min(-.5,Math.min(...logAll)*1.1);
    x.save();x.beginPath();x.rect(mx-2,my-2,cw+4,ch+4);x.clip();
    drawAxes(x,mx,my,cw,ch);
    const thLY=(Math.log10(20)-logMin)/(logMax-logMin);const thPx=my+ch*(1-thLY);
    x.strokeStyle=R(GB[0],GB[1],GB[2],.08);x.setLineDash([3,6]);x.beginPath();x.moveTo(mx,thPx);x.lineTo(mx+cw,thPx);x.stroke();x.setLineDash([]);
    traces.forEach(tr=>{
      const logV=tr.v.map(v=>Math.log10(Math.max(v,.001)));
      x.strokeStyle=R(tr.c[0],tr.c[1],tr.c[2],.7);x.lineWidth=1.5;x.lineJoin='round';
      x.beginPath();for(let i=0;i<=upTo;i++){const px=mx+(i/N)*cw;const ly=(logV[i]-logMin)/(logMax-logMin);const py=my+ch*(1-ly);if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}x.stroke();
      if(upTo>0){const hi=upTo;const hx=mx+(hi/N)*cw,hly=(logV[hi]-logMin)/(logMax-logMin),hy=my+ch*(1-hly);x.fillStyle=R(tr.c[0],tr.c[1],tr.c[2],.8);x.beginPath();x.arc(hx,hy,2.5,0,Math.PI*2);x.fill();}
    });
    x.restore();
    x.save();x.translate(mx-22,my+ch*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('log‚ÇÅ‚ÇÄ W(t)',0,0);x.restore();
    x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('Observations (same data for all strategies)',mx+cw*.5,my+ch+18);
    x.font=`${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.2);x.textAlign='right';x.fillText('1/Œ±',mx-5,clamp(thPx,my,my+ch)+3);
    if(prog>.9){let yOff=my+8;traces.forEach(tr=>{x.font=`${Math.max(10,w*.012)}px 'EB Garamond',serif`;x.fillStyle=R(tr.c[0],tr.c[1],tr.c[2],.5);x.textAlign='right';x.fillText(`${tr.n}: W=${tr.v[N].toFixed(1)}`,mx+cw,yOff);yOff+=14;});}
    if(prog<1)AF.betting=requestAnimationFrame(d);
  }
  stopAF('betting');AF.betting=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ VI. E vs P ‚îÄ‚îÄ
function initCmp(){
  document.getElementById('cm-ef').oninput=function(){document.getElementById('cm-ef-d').textContent=parseFloat(this.value).toFixed(2);};
  const c=document.getElementById('c-cmp');const{x,w,h}=sCanvas(c);
  const mu=parseFloat(document.getElementById('cm-ef').value);
  const N=80,lam=.35;
  const xs=Array.from({length:N},()=>mu+G());
  const eVals=[1];for(let i=0;i<N;i++){const e=Math.exp(lam*xs[i]-lam*lam/2);eVals.push(Math.max(eVals[eVals.length-1]*e,.001));}
  const pVals=[];let sum=0;for(let i=0;i<N;i++){sum+=xs[i];const z=sum/Math.sqrt(i+1);pVals.push(Math.max(2*(1-nCDF(Math.abs(z))),1e-10));}
  let start=0;
  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/12000),upTo=Math.max(1,Math.floor(prog*N));
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    const half=w*.44,gap=w*.04,mx=w*.06,my=h*.14,ch=h*.66;
    const logE=eVals.map(v=>Math.log10(Math.max(v,.001)));const logMax=Math.max(1.5,Math.max(...logE)*1.15);const logMin=Math.min(-.3,Math.min(...logE.slice(0,upTo+1))*1.1);
    x.font=`600 ${Math.max(10,w*.013)}px 'Cinzel',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.45);x.textAlign='center';x.fillText('E-PROCESS',mx+half*.5,my-6);
    x.save();x.beginPath();x.rect(mx-1,my-1,half+2,ch+2);x.clip();
    drawAxes(x,mx,my,half,ch);
    const thLY=(Math.log10(20)-logMin)/(logMax-logMin);const thPx=my+ch*(1-thLY);
    x.strokeStyle=R(GB[0],GB[1],GB[2],.1);x.setLineDash([2,5]);x.beginPath();x.moveTo(mx,thPx);x.lineTo(mx+half,thPx);x.stroke();x.setLineDash([]);
    x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.8);x.lineWidth=1.6;x.lineJoin='round';x.beginPath();
    for(let i=0;i<=upTo;i++){const px=mx+(i/N)*half;const ly=(logE[i]-logMin)/(logMax-logMin);const py=my+ch*(1-ly);if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}x.stroke();
    if(upTo>0){const hx=mx+(upTo/N)*half,hly=(logE[upTo]-logMin)/(logMax-logMin),hy=my+ch*(1-hly);glow(x,hx,hy,12,GB,.15);}
    x.restore();
    x.font=`italic ${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.25);x.textAlign='center';x.fillText('Peek freely ‚Äî always valid',mx+half*.5,my+ch+14);
    const rx=mx+half+gap;
    x.font=`600 ${Math.max(10,w*.013)}px 'Cinzel',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.35);x.textAlign='center';x.fillText('P-VALUE',rx+half*.5,my-6);
    x.save();x.beginPath();x.rect(rx-1,my-1,half+2,ch+2);x.clip();
    drawAxes(x,rx,my,half,ch);
    const pThY=my+ch*(1-.05);
    x.strokeStyle=R(RED[0],RED[1],RED[2],.1);x.setLineDash([2,5]);x.beginPath();x.moveTo(rx,pThY);x.lineTo(rx+half,pThY);x.stroke();x.setLineDash([]);
    x.strokeStyle=R(GD[0],GD[1],GD[2],.6);x.lineWidth=1.4;x.lineJoin='round';x.beginPath();
    for(let i=0;i<upTo;i++){const px=rx+((i+1)/N)*half;const py=my+ch*(1-clamp(pVals[i],0,1));if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}x.stroke();
    x.restore();
    x.font=`italic ${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.25);x.textAlign='center';x.fillText('Valid only at pre-specified n',rx+half*.5,my+ch+14);
    if(prog<1)AF.comparison=requestAnimationFrame(d);
  }
  stopAF('comparison');AF.comparison=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ VII. CONFIDENCE SEQUENCES ‚îÄ‚îÄ
function initCS(){
  document.getElementById('cs-mu').oninput=function(){document.getElementById('cs-mu-d').textContent=parseFloat(this.value).toFixed(2);};
  document.getElementById('cs-al').oninput=function(){document.getElementById('cs-al-d').textContent=Math.round((1-parseFloat(this.value))*100)+'%';};
  const c=document.getElementById('c-cs');const{x,w,h}=sCanvas(c);
  const mu=parseFloat(document.getElementById('cs-mu').value);const alpha=parseFloat(document.getElementById('cs-al').value);
  const N=100;const xs=Array.from({length:N},()=>mu+G());
  const means=[],ups=[],lows=[];let sum=0,sumSq=0;
  for(let i=0;i<N;i++){sum+=xs[i];sumSq+=xs[i]*xs[i];const n=i+1;const m=sum/n;means.push(m);const v=n>1?(sumSq-sum*sum/n)/(n-1):1;const rho=Math.max(.01,n*v/(2*Math.log(1/alpha)+Math.log(1+2*Math.log(1/alpha))));const width=Math.sqrt((n*v+rho)*(Math.log(1+n*v/rho)+2*Math.log(2/alpha)))/n;ups.push(m+width);lows.push(m-width);}
  let start=0;
  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/14000),upTo=Math.max(1,Math.floor(prog*N));
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);glow(x,w*.5,h*.4,w*.3,[20,15,8],.1);
    const mx=w*.1,my=h*.1,cw=w*.8,ch=h*.72;const allV=[...ups.slice(0,upTo),...lows.slice(0,upTo),mu];const yMin=Math.min(...allV)-.25,yMax=Math.max(...allV)+.25;
    const toY=v=>my+ch*(1-(v-yMin)/(yMax-yMin));const toX=i=>mx+(i/(N-1))*cw;
    x.save();x.beginPath();x.rect(mx-1,my-1,cw+2,ch+2);x.clip();
    drawAxes(x,mx,my,cw,ch);
    const trY=toY(mu);x.strokeStyle=R(TEAL[0],TEAL[1],TEAL[2],.2);x.setLineDash([4,5]);x.lineWidth=.8;x.beginPath();x.moveTo(mx,trY);x.lineTo(mx+cw,trY);x.stroke();x.setLineDash([]);
    if(upTo>1){
      x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.05);x.beginPath();for(let i=0;i<upTo;i++){if(i===0)x.moveTo(toX(i),toY(ups[i]));else x.lineTo(toX(i),toY(ups[i]));}for(let i=upTo-1;i>=0;i--)x.lineTo(toX(i),toY(lows[i]));x.closePath();x.fill();
      x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.2);x.lineWidth=.7;x.beginPath();for(let i=0;i<upTo;i++){if(i===0)x.moveTo(toX(i),toY(ups[i]));else x.lineTo(toX(i),toY(ups[i]));}x.stroke();
      x.beginPath();for(let i=0;i<upTo;i++){if(i===0)x.moveTo(toX(i),toY(lows[i]));else x.lineTo(toX(i),toY(lows[i]));}x.stroke();
      x.strokeStyle=R(GB[0],GB[1],GB[2],.65);x.lineWidth=1.4;x.beginPath();for(let i=0;i<upTo;i++){if(i===0)x.moveTo(toX(i),toY(means[i]));else x.lineTo(toX(i),toY(means[i]));}x.stroke();
      const hx=toX(upTo-1),hy=toY(means[upTo-1]);glow(x,hx,hy,14,GB,.15);x.fillStyle=R(GB[0],GB[1],GB[2],.9);x.beginPath();x.arc(hx,hy,2,0,Math.PI*2);x.fill();
      const lastUp=toY(ups[upTo-1]),lastLow=toY(lows[upTo-1]);x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.25);x.lineWidth=.8;const bx=hx+10;
      x.beginPath();x.moveTo(bx-4,lastUp);x.lineTo(bx,lastUp);x.lineTo(bx,lastLow);x.lineTo(bx-4,lastLow);x.stroke();
      x.beginPath();x.moveTo(bx-3,lastUp+4);x.lineTo(bx,lastUp);x.lineTo(bx+3,lastUp+4);x.stroke();
      x.beginPath();x.moveTo(bx-3,lastLow-4);x.lineTo(bx,lastLow);x.lineTo(bx+3,lastLow-4);x.stroke();
    }
    x.restore();
    x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(TEAL[0],TEAL[1],TEAL[2],.35);x.textAlign='left';x.fillText(`True Œº = ${mu.toFixed(2)}`,mx+cw+6,clamp(toY(mu),my+5,my+ch-5));
    if(upTo>1){const lastW=ups[upTo-1]-lows[upTo-1];const midY=(toY(ups[upTo-1])+toY(lows[upTo-1]))/2;const bx=toX(upTo-1)+18;x.font=`${Math.max(10,w*.012)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.4);x.textAlign='left';x.fillText(`¬± ${(lastW/2).toFixed(3)}`,bx+4,clamp(midY+3,my+10,my+ch-5));}
    x.font=`${Math.max(10,w*.013)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.35);x.textAlign='right';x.fillText(`${Math.round((1-alpha)*100)}% Confidence Sequence`,mx+cw,my+10);
    x.font=`${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.25);x.fillText(`[${lows[upTo-1]?.toFixed(3)??'‚Äî'}, ${ups[upTo-1]?.toFixed(3)??'‚Äî'}]`,mx+cw,my+22);
    x.save();x.translate(mx-22,my+ch*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('Parameter',0,0);x.restore();
    x.font=`italic ${Math.max(9,w*.011)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('Sample size',mx+cw*.5,my+ch+18);
    if(upTo>N*.4){x.font=`italic ${Math.max(10,w*.012)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.2);x.textAlign='center';x.fillText('Valid at every time ‚Äî stop whenever you wish',mx+cw*.5,my+ch+32);}
    if(prog<1)AF.confseq=requestAnimationFrame(d);
  }
  stopAF('confseq');AF.confseq=requestAnimationFrame(d);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê  VIII. PHYSICS  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initPhysics(){initParticle();initMeanTest();}

// ‚îÄ‚îÄ PARTICLE DETECTION ‚îÄ‚îÄ
function initParticle(){
  document.getElementById('ph-sig').oninput=function(){document.getElementById('ph-sig-d').textContent=parseFloat(this.value).toFixed(1);};
  document.getElementById('ph-bg').oninput=function(){document.getElementById('ph-bg-d').textContent=parseFloat(this.value).toFixed(1);};
  const c=document.getElementById('c-particle');const{x,w,h}=sCanvas(c);
  const bg0=parseFloat(document.getElementById('ph-bg').value);
  const sig=parseFloat(document.getElementById('ph-sig').value);
  const lam0=bg0, lam1=bg0+sig;
  const N=120;
  // Generate collision data: first 30 background only, then signal appears
  const changeAt=30;
  const counts=[];
  for(let i=0;i<N;i++){
    counts.push(poisson(i<changeAt?lam0:lam1));
  }
  // E-values: Poisson LR = (lam1/lam0)^x * exp(lam0-lam1)
  const logLR=Math.log(lam1/lam0);
  const drift=lam0-lam1;
  const eProc=[1];
  for(let i=0;i<N;i++){
    const logE=counts[i]*logLR+drift;
    eProc.push(Math.max(eProc[eProc.length-1]*Math.exp(logE),1e-6));
  }

  // Particle sparkles
  let sparks=[];
  let start=0;

  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/18000),upTo=Math.floor(prog*N);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    glow(x,w*.5,h*.35,w*.3,[18,12,6],.18);

    const mx=w*.11,my=h*.1,cw=w*.8,ch=h*.35;
    const mx2=mx,my2=h*.56,ch2=h*.34;

    // ‚îÄ‚îÄ TOP: Event counts histogram ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.4);x.textAlign='left';x.fillText('EVENT COUNTS PER WINDOW',mx,my-4);

    const maxC=Math.max(15,...counts)+2;
    // change point marker
    if(upTo>changeAt){
      const cpx=mx+(changeAt/N)*cw;
      x.fillStyle=R(RED[0],RED[1],RED[2],.04);x.fillRect(cpx,my,mx+cw-cpx,ch);
      x.strokeStyle=R(RED[0],RED[1],RED[2],.15);x.setLineDash([2,4]);x.lineWidth=.5;
      x.beginPath();x.moveTo(cpx,my);x.lineTo(cpx,my+ch);x.stroke();x.setLineDash([]);
      x.font=`italic ${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(RED[0],RED[1],RED[2],.35);x.textAlign='center';x.fillText('signal onset',cpx,my+ch+12);
    }
    // bars
    const bw=Math.max(1,(cw/N)*.7);
    for(let i=0;i<upTo;i++){
      const bx=mx+(i/N)*cw;
      const bh=(counts[i]/maxC)*ch;
      const isSig=i>=changeAt;
      const col=isSig?GB:GD;
      const al=isSig?.4:.25;
      x.fillStyle=R(col[0],col[1],col[2],al);
      x.fillRect(bx,my+ch-bh,bw,bh);
      // sparkle on new arrival
      if(i===upTo-1&&isSig&&counts[i]>lam0+1){
        for(let k=0;k<3;k++){sparks.push({x:bx+bw/2,y:my+ch-bh,vx:(Math.random()-.5)*1.5,vy:-Math.random()*1.5,life:1});}
      }
    }
    // expected rate lines
    x.strokeStyle=R(GD[0],GD[1],GD[2],.15);x.lineWidth=.5;x.setLineDash([3,5]);
    const bgY=my+ch-(lam0/maxC)*ch;
    x.beginPath();x.moveTo(mx,bgY);x.lineTo(mx+cw,bgY);x.stroke();x.setLineDash([]);
    x.font=`italic ${Math.max(8,w*.008)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.25);x.textAlign='right';x.fillText(`Œª‚ÇÄ=${lam0.toFixed(0)}`,mx-4,bgY+3);
    // axis
    x.strokeStyle=R(GD[0],GD[1],GD[2],.12);x.lineWidth=.5;x.beginPath();x.moveTo(mx,my+ch);x.lineTo(mx+cw,my+ch);x.stroke();

    // Sparkles
    sparks=sparks.filter(s=>{s.x+=s.vx;s.y+=s.vy;s.vy+=.03;s.life-=.015;if(s.life>0){x.fillStyle=R(GB[0],GB[1],GB[2],s.life*.5);x.beginPath();x.arc(s.x,s.y,1.2*s.life,0,Math.PI*2);x.fill();return true;}return false;});

    // ‚îÄ‚îÄ BOTTOM: E-process (log scale) ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.4);x.textAlign='left';x.fillText('E-PROCESS ‚Äî EVIDENCE FOR NEW PARTICLE',mx2,my2-4);

    const logE=eProc.map(v=>Math.log10(Math.max(v,1e-6)));
    const logMax=Math.max(2,Math.max(...logE)*1.15);
    const logMin=Math.min(-1,Math.min(...logE)*1.1);

    x.save();x.beginPath();x.rect(mx2-2,my2-2,cw+4,ch2+4);x.clip();
    drawAxes(x,mx2,my2,cw,ch2);

    // 5-sigma threshold ‚âà 1/3e-7 ‚Üí log10 ‚âà 6.5, use 1/alpha=20 for visualization
    const thVal=Math.log10(20);
    const thFrac=(thVal-logMin)/(logMax-logMin);
    const thY=my2+ch2*(1-thFrac);
    x.strokeStyle=R(GB[0],GB[1],GB[2],.12);x.setLineDash([3,6]);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx2,thY);x.lineTo(mx2+cw,thY);x.stroke();x.setLineDash([]);

    // change point
    if(upTo>changeAt){
      const cpx=mx2+(changeAt/N)*cw;
      x.strokeStyle=R(RED[0],RED[1],RED[2],.08);x.setLineDash([2,4]);
      x.beginPath();x.moveTo(cpx,my2);x.lineTo(cpx,my2+ch2);x.stroke();x.setLineDash([]);
    }

    if(upTo>0){
      x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.85);x.lineWidth=2;x.lineJoin='round';
      x.beginPath();
      for(let i=0;i<=upTo;i++){
        const px=mx2+(i/N)*cw;
        const ly=(logE[i]-logMin)/(logMax-logMin);
        const py=my2+ch2*(1-ly);
        if(i===0)x.moveTo(px,py);else x.lineTo(px,py);
      }
      x.stroke();
      const hx=mx2+(upTo/N)*cw,hly=(logE[upTo]-logMin)/(logMax-logMin),hy=my2+ch2*(1-hly);
      glow(x,hx,hy,18,GB,.2);x.fillStyle=R(GB[0],GB[1],GB[2],.9);x.beginPath();x.arc(hx,hy,2.5,0,Math.PI*2);x.fill();

      // Crossing animation
      let crossIdx=-1;
      for(let i=1;i<=upTo;i++){if(eProc[i]>=20&&eProc[i-1]<20){crossIdx=i;break;}}
      if(crossIdx>0){
        const cx2=mx2+(crossIdx/N)*cw,cy2=my2+ch2*(1-(logE[crossIdx]-logMin)/(logMax-logMin));
        const vp=Math.min(1,(upTo-crossIdx)/20);
        if(vp>0){
          glow(x,cx2,cy2,35*eIO(vp),GB,.12);
          x.strokeStyle=R(GB[0],GB[1],GB[2],(.5-vp*.4));x.lineWidth=.8;
          x.beginPath();x.arc(cx2,cy2,eIO(vp)*50,0,Math.PI*2);x.stroke();
        }
      }
    }
    x.restore();

    // Labels
    x.font=`${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.25);x.textAlign='right';x.fillText('1/Œ±',mx2-5,clamp(thY,my2,my2+ch2)+3);
    x.save();x.translate(mx2-22,my2+ch2*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('log‚ÇÅ‚ÇÄ W(t)',0,0);x.restore();
    x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('Collision windows',mx2+cw*.5,my2+ch2+14);

    if(upTo>0){x.font=`${Math.max(11,w*.014)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.45);x.textAlign='right';x.fillText(`W = ${eProc[upTo].toFixed(2)}`,mx2+cw,my2+10);}

    if(prog<1)AF.particle=requestAnimationFrame(d);
  }
  stopAF('particle');start=0;sparks=[];AF.particle=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ SEQUENTIAL MEAN TEST (TwoSidedNormalMixture from martingales.py) ‚îÄ‚îÄ
function initMeanTest(){
  document.getElementById('mt-mu').oninput=function(){document.getElementById('mt-mu-d').textContent=parseFloat(this.value).toFixed(2);};
  document.getElementById('mt-al').oninput=function(){document.getElementById('mt-al-d').textContent=parseFloat(this.value).toFixed(2);};
  const c=document.getElementById('c-meantest');const{x,w,h}=sCanvas(c);
  const mu=parseFloat(document.getElementById('mt-mu').value);
  const alpha=parseFloat(document.getElementById('mt-al').value);
  const N=200;

  // TwoSidedNormalMixture.best_rho (martingales.py line 106-108)
  const v_opt=N/2; // tune for expected sample size
  const rho=v_opt/(2*Math.log(1/alpha)+Math.log(1+2*Math.log(1/alpha)));
  const logThreshold=Math.log(1/alpha);

  // Generate observations X_i ~ N(mu, 1) and compute statistics
  const obs=[],runMean=[0],runSum=[0],wealth=[1],csBound=[Infinity];
  for(let i=0;i<N;i++){
    const xi=mu+G(); // X_i ~ N(mu, 1)
    obs.push(xi);
    const s=runSum[runSum.length-1]+xi;
    runSum.push(s);
    runMean.push(s/(i+1));
    const v=i+1; // intrinsic time = t (known variance=1)
    // TwoSidedNormalMixture.log_superMG (martingales.py line 95-97)
    const logM=0.5*Math.log(rho/(v+rho))+s*s/(2*(v+rho));
    wealth.push(Math.exp(logM));
    // TwoSidedNormalMixture.bound (martingales.py line 102-103)
    const bd=Math.sqrt((v+rho)*(Math.log(1+v/rho)+2*logThreshold));
    csBound.push(bd/v); // confidence band for the MEAN = bound/t
  }
  let start=0, rejected=-1;
  // Find first rejection time
  for(let i=1;i<=N;i++){if(wealth[i]>=1/alpha){rejected=i;break;}}

  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/18000),upTo=Math.floor(prog*N);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    glow(x,w*.5,h*.4,w*.28,[20,14,6],.14);
    const mx=w*.11,my=h*.1,cw=w*.8,ch=h*.35;
    const mx2=mx,my2=h*.56,ch2=h*.34;

    // ‚îÄ‚îÄ TOP: Running mean with confidence sequence band ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.4);x.textAlign='left';x.fillText('RUNNING MEAN XÃÑ(t) WITH CONFIDENCE SEQUENCE',mx,my-4);
    // Compute y-range from visible data
    let yMin=-0.8,yMax=0.8;
    for(let i=1;i<=Math.min(upTo,N);i++){
      const rm=runMean[i],cb=csBound[i];
      if(isFinite(cb)){yMin=Math.min(yMin,rm-cb-.1);yMax=Math.max(yMax,rm+cb+.1);}
      else{yMin=Math.min(yMin,rm-.5);yMax=Math.max(yMax,rm+.5);}
    }
    x.save();x.beginPath();x.rect(mx-2,my-2,cw+4,ch+4);x.clip();
    drawAxes(x,mx,my,cw,ch);
    // zero line (null hypothesis: mu=0)
    const zeroY=my+ch*(1-(0-yMin)/(yMax-yMin));
    x.strokeStyle=R(GD[0],GD[1],GD[2],.1);x.setLineDash([2,4]);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx,zeroY);x.lineTo(mx+cw,zeroY);x.stroke();x.setLineDash([]);
    x.font=`italic ${Math.max(8,w*.008)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.2);x.textAlign='right';x.fillText('Œº‚ÇÄ = 0',mx-4,zeroY+3);

    // Confidence sequence band (filled)
    if(upTo>1){
      x.beginPath();
      // upper edge
      for(let i=1;i<=upTo;i++){
        const px=mx+(i/N)*cw;const ub=Math.min(runMean[i]+csBound[i],yMax);
        const py=my+ch*(1-(ub-yMin)/(yMax-yMin));
        if(i===1)x.moveTo(px,py);else x.lineTo(px,py);
      }
      // lower edge (reverse)
      for(let i=upTo;i>=1;i--){
        const px=mx+(i/N)*cw;const lb=Math.max(runMean[i]-csBound[i],yMin);
        const py=my+ch*(1-(lb-yMin)/(yMax-yMin));
        x.lineTo(px,py);
      }
      x.closePath();x.fillStyle=R(TEAL[0],TEAL[1],TEAL[2],.06);x.fill();
      // upper/lower border lines
      x.strokeStyle=R(TEAL[0],TEAL[1],TEAL[2],.2);x.lineWidth=.8;
      x.beginPath();
      for(let i=1;i<=upTo;i++){const px=mx+(i/N)*cw;const ub=Math.min(runMean[i]+csBound[i],yMax);const py=my+ch*(1-(ub-yMin)/(yMax-yMin));if(i===1)x.moveTo(px,py);else x.lineTo(px,py);}
      x.stroke();
      x.beginPath();
      for(let i=1;i<=upTo;i++){const px=mx+(i/N)*cw;const lb=Math.max(runMean[i]-csBound[i],yMin);const py=my+ch*(1-(lb-yMin)/(yMax-yMin));if(i===1)x.moveTo(px,py);else x.lineTo(px,py);}
      x.stroke();
    }
    // Running mean line
    if(upTo>0){
      x.strokeStyle=R(GD[0],GD[1],GD[2],.65);x.lineWidth=1.5;x.lineJoin='round';
      x.beginPath();
      for(let i=1;i<=upTo;i++){const px=mx+(i/N)*cw;const py=my+ch*(1-(runMean[i]-yMin)/(yMax-yMin));if(i===1)x.moveTo(px,py);else x.lineTo(px,py);}
      x.stroke();
      // head dot
      const hx=mx+(upTo/N)*cw,hy=my+ch*(1-(runMean[upTo]-yMin)/(yMax-yMin));
      x.fillStyle=R(GD[0],GD[1],GD[2],.8);x.beginPath();x.arc(hx,hy,2,0,Math.PI*2);x.fill();
    }
    // Rejection marker
    if(rejected>0&&upTo>=rejected){
      const rx=mx+(rejected/N)*cw;
      x.strokeStyle=R(GB[0],GB[1],GB[2],.2);x.lineWidth=.8;
      x.beginPath();x.moveTo(rx,my);x.lineTo(rx,my+ch);x.stroke();
      x.font=`italic ${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.35);x.textAlign='center';x.fillText('reject H‚ÇÄ',rx,my+ch+12);
    }
    x.restore();
    if(upTo>0){x.font=`italic ${Math.max(8,w*.008)}px 'EB Garamond',serif`;x.fillStyle=R(TEAL[0],TEAL[1],TEAL[2],.3);x.textAlign='right';x.fillText(`XÃÑ = ${runMean[upTo].toFixed(3)}   CS: [${(runMean[upTo]-csBound[upTo]).toFixed(2)}, ${(runMean[upTo]+csBound[upTo]).toFixed(2)}]`,mx+cw,my+10);}

    // ‚îÄ‚îÄ BOTTOM: E-process wealth (TwoSidedNormalMixture supermartingale) ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.4);x.textAlign='left';x.fillText('E-PROCESS WEALTH (MIXTURE SUPERMARTINGALE)',mx2,my2-4);
    const logW=wealth.map(v=>Math.log10(Math.max(v,1e-6)));
    const lwSlice=logW.slice(0,upTo+1);
    const lwMax=Math.max(1.5,Math.max(...lwSlice)*1.15);
    const lwMin=Math.min(-1,Math.min(...lwSlice)*1.1);

    x.save();x.beginPath();x.rect(mx2-2,my2-2,cw+4,ch2+4);x.clip();
    drawAxes(x,mx2,my2,cw,ch2);
    // 1/alpha threshold
    const thVal=Math.log10(1/alpha);const thFrac=(thVal-lwMin)/(lwMax-lwMin);
    const thY=my2+ch2*(1-clamp(thFrac,0,1));
    x.strokeStyle=R(RED[0],RED[1],RED[2],.12);x.setLineDash([3,6]);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx2,thY);x.lineTo(mx2+cw,thY);x.stroke();x.setLineDash([]);
    // M=1 line (log10(1)=0)
    const oneF=(0-lwMin)/(lwMax-lwMin);const oneY=my2+ch2*(1-clamp(oneF,0,1));
    x.strokeStyle=R(GD[0],GD[1],GD[2],.06);x.setLineDash([2,4]);
    x.beginPath();x.moveTo(mx2,oneY);x.lineTo(mx2+cw,oneY);x.stroke();x.setLineDash([]);

    if(upTo>0){
      x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.85);x.lineWidth=1.8;x.lineJoin='round';
      x.beginPath();
      for(let i=0;i<=upTo;i++){const px=mx2+(i/N)*cw;const ly=(logW[i]-lwMin)/(lwMax-lwMin);const py=my2+ch2*(1-clamp(ly,0,1));if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}
      x.stroke();
      const hx=mx2+(upTo/N)*cw,hly=(logW[upTo]-lwMin)/(lwMax-lwMin),hy=my2+ch2*(1-clamp(hly,0,1));
      glow(x,hx,hy,16,GB,.18);x.fillStyle=R(GB[0],GB[1],GB[2],.9);x.beginPath();x.arc(hx,hy,2.5,0,Math.PI*2);x.fill();
      // Crossing animation
      if(rejected>0&&upTo>=rejected){
        const cx2=mx2+(rejected/N)*cw,cy2=my2+ch2*(1-(logW[rejected]-lwMin)/(lwMax-lwMin));
        const vp=Math.min(1,(upTo-rejected)/20);
        if(vp>0){glow(x,cx2,cy2,35*eIO(vp),GB,.12);x.strokeStyle=R(GB[0],GB[1],GB[2],(.5-vp*.4));x.lineWidth=.8;x.beginPath();x.arc(cx2,cy2,eIO(vp)*50,0,Math.PI*2);x.stroke();}
      }
    }
    x.restore();

    x.font=`${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(RED[0],RED[1],RED[2],.2);x.textAlign='right';x.fillText('1/Œ±',mx2-5,clamp(thY,my2,my2+ch2)+3);
    x.save();x.translate(mx2-22,my2+ch2*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('log‚ÇÅ‚ÇÄ M(t)',0,0);x.restore();
    x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('Observations',mx2+cw*.5,my2+ch2+14);

    if(upTo>0){x.font=`${Math.max(11,w*.014)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.45);x.textAlign='right';x.fillText(`M = ${wealth[upTo].toFixed(3)}   œÅ = ${rho.toFixed(1)}`,mx2+cw,my2+10);}

    if(prog<1)AF.meantest=requestAnimationFrame(d);
  }
  stopAF('meantest');start=0;AF.meantest=requestAnimationFrame(d);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê  IX. FINANCE  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initFinance(){initVaR();initRegime();}

// ‚îÄ‚îÄ VaR BACKTESTING ‚îÄ‚îÄ
function initVaR(){
  const qSl=document.getElementById('vr-q');
  qSl.oninput=function(){
    const v=parseFloat(this.value);
    const labels=['Honest','Fair','Mediocre','Poor','Reckless'];
    document.getElementById('vr-q-d').textContent=labels[Math.min(4,Math.floor(v*5))];
  };
  qSl.oninput();

  const c=document.getElementById('c-var');const{x,w,h}=sCanvas(c);
  const quality=parseFloat(qSl.value); // 0=honest, 1=reckless
  const N=300;
  const alpha_var=0.01; // VaR exceedance probability claimed
  // True exceedance rate: honest bank=1%, reckless=5-10%
  const trueExceed=alpha_var+quality*0.08;
  // Betting fraction must be O(alpha_var) for rare-event tests.
  // With lam=0.4 the process dies: E[log((1-0.4)+0.4*E)] < 0 even under alternative.
  // With lam=alpha_var: non-exceed yields 0.99 (tiny decay), exceed yields ~1.99 (doubles).
  // E[log inc] > 0 iff true exceedance rate > alpha_var. Correct behavior.
  const lam=alpha_var; // betting fraction ‚Äî matched to exceedance scale

  // Generate returns and VaR exceedances
  // E-statistic for quantile (Example 16.9): e^q_Œ≤(x,r) = 1{x>r}/(1-Œ≤)
  // E-process via betting fractions (Definition 7.21, EProcessUpdater):
  //   M_t = M_{t-1} * ((1-Œª_t) + Œª_t * E_t)
  const losses=[],exceed=[],eProc=[1];
  for(let i=0;i<N;i++){
    const loss=G(); // standardized loss ~ N(0,1)
    const bankVaR=2.33-quality*1.2; // honest=2.33 (true 99th %ile), reckless‚Üílower
    const exc=loss>bankVaR?1:0;
    losses.push(loss);exceed.push(exc);
    // Example 16.9: e = 1{loss > VaR} / (1-Œ≤) where 1-Œ≤ = alpha_var
    const eVal=exc?(1/alpha_var):0; // 100 on exceedance, 0 otherwise
    // Equation 16.15: M_t = M_{t-1} * ((1-Œª) + Œª*E_t)
    const inc=(1-lam)+lam*eVal;
    eProc.push(Math.max(eProc[eProc.length-1]*Math.max(inc,1e-6),1e-6));
  }
  let start=0;

  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/20000),upTo=Math.floor(prog*N);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    glow(x,w*.5,h*.35,w*.3,[15,10,5],.15);

    const mx=w*.11,my=h*.08,cw=w*.8,ch=h*.32;
    const mx2=mx,my2=h*.52,ch2=h*.38;

    // ‚îÄ‚îÄ TOP: Loss distribution with VaR exceedances ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.4);x.textAlign='left';x.fillText('DAILY P&L ¬∑ VaR EXCEEDANCES',mx,my-4);

    const lSlice=losses.slice(0,upTo);
    const lMin=Math.min(-3,Math.min(...lSlice,0)-.5),lMax=Math.max(3,Math.max(...lSlice,0)+.5);

    x.save();x.beginPath();x.rect(mx-2,my-2,cw+4,ch+4);x.clip();
    // zero line
    const zY=my+ch*(1-(0-lMin)/(lMax-lMin));
    x.strokeStyle=R(GD[0],GD[1],GD[2],.08);x.lineWidth=.5;x.beginPath();x.moveTo(mx,zY);x.lineTo(mx+cw,zY);x.stroke();

    // bars
    for(let i=0;i<upTo;i++){
      const px=mx+(i/N)*cw;const bw=Math.max(1,(cw/N)*.8);
      const ly=(losses[i]-lMin)/(lMax-lMin);const py=my+ch*(1-ly);
      const col=exceed[i]?RED:GD;
      const al=exceed[i]?.6:.2;
      x.fillStyle=R(col[0],col[1],col[2],al);
      x.fillRect(px,Math.min(py,zY),bw,Math.abs(py-zY));
      if(exceed[i]){
        // exceedance marker
        x.fillStyle=R(RED[0],RED[1],RED[2],.7);
        x.beginPath();x.arc(px+bw/2,py,2,0,Math.PI*2);x.fill();
      }
    }
    x.restore();

    // ‚îÄ‚îÄ BOTTOM: E-process ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.4);x.textAlign='left';x.fillText('BACKTEST E-PROCESS',mx2,my2-4);

    const logE=eProc.map(v=>Math.log10(Math.max(v,.001)));
    const leSlice=logE.slice(0,upTo+1);
    const logMax=Math.max(2,Math.max(...leSlice)*1.15);
    const logMin=Math.min(-.5,Math.min(...leSlice)*1.1);

    x.save();x.beginPath();x.rect(mx2-2,my2-2,cw+4,ch2+4);x.clip();
    drawAxes(x,mx2,my2,cw,ch2);

    // threshold
    const thVal=Math.log10(20);const thFrac=(thVal-logMin)/(logMax-logMin);
    const thY=my2+ch2*(1-clamp(thFrac,0,1));
    x.strokeStyle=R(GB[0],GB[1],GB[2],.12);x.setLineDash([3,6]);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx2,thY);x.lineTo(mx2+cw,thY);x.stroke();x.setLineDash([]);

    if(upTo>0){
      // Mark exceedances on e-process
      for(let i=0;i<upTo;i++){
        if(exceed[i]){
          const px=mx2+((i+1)/N)*cw;const ly=(logE[i+1]-logMin)/(logMax-logMin);const py=my2+ch2*(1-clamp(ly,0,1));
          x.strokeStyle=R(RED[0],RED[1],RED[2],.15);x.lineWidth=.5;
          x.beginPath();x.moveTo(px,my2);x.lineTo(px,my2+ch2);x.stroke();
          glow(x,px,py,8,RED,.08);
        }
      }

      x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.85);x.lineWidth=2;x.lineJoin='round';
      x.beginPath();
      for(let i=0;i<=upTo;i++){const px=mx2+(i/N)*cw;const ly=(logE[i]-logMin)/(logMax-logMin);const py=my2+ch2*(1-clamp(ly,0,1));if(i===0)x.moveTo(px,py);else x.lineTo(px,py);}
      x.stroke();
      const hx=mx2+(upTo/N)*cw,hly=(logE[upTo]-logMin)/(logMax-logMin),hy=my2+ch2*(1-clamp(hly,0,1));
      glow(x,hx,hy,16,GB,.18);x.fillStyle=R(GB[0],GB[1],GB[2],.9);x.beginPath();x.arc(hx,hy,2.5,0,Math.PI*2);x.fill();
    }
    x.restore();

    x.font=`${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.25);x.textAlign='right';x.fillText('1/Œ±',mx2-5,clamp(thY,my2,my2+ch2)+3);
    x.save();x.translate(mx2-22,my2+ch2*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('log‚ÇÅ‚ÇÄ W(t)',0,0);x.restore();
    x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('Trading days',mx2+cw*.5,my2+ch2+14);

    // Exceedance count
    if(upTo>0){
      const excCount=exceed.slice(0,upTo).reduce((a,b)=>a+b,0);
      const excRate=(excCount/upTo*100).toFixed(1);
      x.font=`${Math.max(10,w*.012)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.4);x.textAlign='right';
      x.fillText(`Exceedances: ${excCount}/${upTo} (${excRate}%)  ¬∑  Claimed: ${(alpha_var*100).toFixed(0)}%`,mx+cw,my+ch+12);
      x.font=`${Math.max(11,w*.014)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.45);x.textAlign='right';x.fillText(`W = ${eProc[upTo].toFixed(2)}`,mx2+cw,my2+10);
    }

    if(prog<1)AF.var=requestAnimationFrame(d);
  }
  stopAF('var');start=0;AF.var=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ REGIME DETECTION ‚îÄ‚îÄ
function initRegime(){
  document.getElementById('rg-vr').oninput=function(){document.getElementById('rg-vr-d').textContent=parseFloat(this.value).toFixed(1)+'√ó';};
  const c=document.getElementById('c-regime');const{x,w,h}=sCanvas(c);
  const volRatio=parseFloat(document.getElementById('rg-vr').value);
  const N=250;
  // Regime changes at random points
  const regimes=[];let regime=0;
  const changePoints=[];
  for(let i=0;i<N;i++){
    if(Math.random()<0.008&&i>20&&(changePoints.length===0||i-changePoints[changePoints.length-1]>30)){
      regime=1-regime;changePoints.push(i);
    }
    regimes.push(regime);
  }
  // Generate returns
  const sigma0=1,sigma1=sigma0*volRatio;
  const returns=[];
  for(let i=0;i<N;i++){returns.push(G()*(regimes[i]?sigma1:sigma0));}

  // ConformalCUSUM e-detector (cusum.py): testing sigma=sigma0 vs sigma=sigma1
  // E-statistic for variance: e(x,r) = x^2/r (Example 16.8, backtest e-statistic)
  // Under null (sigma=sigma0): E[X^2/sigma0^2] = 1 (valid e-variable)
  // Under alt  (sigma=sigma1): E[log(X^2/sigma0^2)] = -1.27 + 2*log(sigma1/sigma0) > 0
  const cusum=[0],alarms=[]; // start at 0.0 per ConformalCUSUM.reset()
  const threshold=20.0; // ConformalCUSUM default threshold
  const minValue=1e-10; // ConformalCUSUM.min_value (truncation floor, NOT 1)
  for(let i=0;i<N;i++){
    const eVal=(returns[i]*returns[i])/(sigma0*sigma0); // e-statistic for variance
    // Standard CUSUM: max(stat * e_value, min_value) ‚Äî line 65-68 of cusum.py
    const newVal=Math.max(cusum[cusum.length-1]*eVal, minValue);
    cusum.push(newVal);
    // Alarm check + reset to 0.0 ‚Äî line 74-78 of cusum.py
    if(newVal>=threshold){alarms.push(i+1);cusum[cusum.length-1]=0.0;}
  }
  let start=0;

  function d(t){
    if(!start)start=t;const el=t-start,prog=Math.min(1,el/20000),upTo=Math.floor(prog*N);
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    glow(x,w*.5,h*.35,w*.3,[15,10,5],.14);

    const mx=w*.11,my=h*.08,cw=w*.8,ch=h*.3;
    const mx2=mx,my2=h*.5,ch2=h*.4;

    // ‚îÄ‚îÄ TOP: Returns with regime coloring ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.4);x.textAlign='left';x.fillText('MARKET RETURNS',mx,my-4);

    const rSlice=returns.slice(0,upTo);
    const rMax=Math.max(4,Math.max(...rSlice.map(Math.abs))*1.2);

    x.save();x.beginPath();x.rect(mx-2,my-2,cw+4,ch+4);x.clip();

    // Regime background shading
    for(let i=0;i<upTo;i++){
      if(regimes[i]){
        const px=mx+(i/N)*cw;
        x.fillStyle=R(RED[0],RED[1],RED[2],.03);
        x.fillRect(px,my,cw/N+1,ch);
      }
    }

    // Zero line
    const zY=my+ch*.5;
    x.strokeStyle=R(GD[0],GD[1],GD[2],.08);x.lineWidth=.5;x.beginPath();x.moveTo(mx,zY);x.lineTo(mx+cw,zY);x.stroke();

    // Returns
    for(let i=0;i<upTo;i++){
      const px=mx+(i/N)*cw;const bw=Math.max(1,(cw/N)*.8);
      const ry=returns[i]/rMax*ch*.5;
      const col=regimes[i]?RED:GD;
      const al=regimes[i]?.35:.2;
      x.fillStyle=R(col[0],col[1],col[2],al);
      x.fillRect(px,zY-Math.max(0,ry),bw,Math.abs(ry));
    }

    // Change point markers
    changePoints.forEach(cp=>{
      if(cp<upTo){
        const cpx=mx+(cp/N)*cw;
        x.strokeStyle=R(RED[0],RED[1],RED[2],.25);x.setLineDash([2,3]);x.lineWidth=.5;
        x.beginPath();x.moveTo(cpx,my);x.lineTo(cpx,my+ch);x.stroke();x.setLineDash([]);
      }
    });
    x.restore();

    // ‚îÄ‚îÄ BOTTOM: CUSUM e-detector ‚îÄ‚îÄ
    x.font=`${Math.max(9,w*.01)}px 'Cinzel',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.4);x.textAlign='left';x.fillText('CUSUM E-DETECTOR',mx2,my2-4);

    const logC=cusum.map(v=>Math.log10(Math.max(v,1e-10)));
    const lcSlice=logC.slice(0,upTo+1);
    const lcMax=Math.max(Math.log10(threshold)*1.3,Math.max(...lcSlice)*1.15);
    const lcMin=Math.min(...lcSlice,-1);

    x.save();x.beginPath();x.rect(mx2-2,my2-2,cw+4,ch2+4);x.clip();
    drawAxes(x,mx2,my2,cw,ch2);

    // threshold
    const thVal=Math.log10(threshold);
    const thY=my2+ch2*(1-(thVal-lcMin)/(lcMax-lcMin));
    x.strokeStyle=R(GB[0],GB[1],GB[2],.12);x.setLineDash([3,6]);x.lineWidth=.5;
    x.beginPath();x.moveTo(mx2,thY);x.lineTo(mx2+cw,thY);x.stroke();x.setLineDash([]);

    // Alarm markers
    alarms.forEach(a=>{
      if(a<=upTo){
        const ax=mx2+(a/N)*cw;
        x.strokeStyle=R(TEAL[0],TEAL[1],TEAL[2],.2);x.lineWidth=.8;
        x.beginPath();x.moveTo(ax,my2);x.lineTo(ax,my2+ch2);x.stroke();
        glow(x,ax,thY,12,TEAL,.12);
        x.fillStyle=R(TEAL[0],TEAL[1],TEAL[2],.7);x.beginPath();x.arc(ax,thY,3,0,Math.PI*2);x.fill();
      }
    });

    // Change points in detector panel
    changePoints.forEach(cp=>{
      if(cp<upTo){
        const cpx=mx2+(cp/N)*cw;
        x.strokeStyle=R(RED[0],RED[1],RED[2],.1);x.setLineDash([2,4]);x.lineWidth=.5;
        x.beginPath();x.moveTo(cpx,my2);x.lineTo(cpx,my2+ch2);x.stroke();x.setLineDash([]);
      }
    });

    // CUSUM line
    if(upTo>0){
      x.strokeStyle=R(GOLD[0],GOLD[1],GOLD[2],.85);x.lineWidth=1.8;x.lineJoin='round';
      x.beginPath();
      for(let i=0;i<=upTo;i++){
        const px=mx2+(i/N)*cw;
        const ly=(logC[i]-lcMin)/(lcMax-lcMin);
        const py=my2+ch2*(1-clamp(ly,0,1));
        if(i===0)x.moveTo(px,py);else x.lineTo(px,py);
      }
      x.stroke();
      const hx=mx2+(upTo/N)*cw,hly=(logC[upTo]-lcMin)/(lcMax-lcMin),hy=my2+ch2*(1-clamp(hly,0,1));
      glow(x,hx,hy,14,GB,.16);x.fillStyle=R(GB[0],GB[1],GB[2],.9);x.beginPath();x.arc(hx,hy,2.5,0,Math.PI*2);x.fill();
    }
    x.restore();

    x.font=`${Math.max(8,w*.009)}px 'EB Garamond',serif`;x.fillStyle=R(GB[0],GB[1],GB[2],.25);x.textAlign='right';x.fillText('1/Œ±',mx2-5,clamp(thY,my2,my2+ch2)+3);
    x.save();x.translate(mx2-22,my2+ch2*.5);x.rotate(-Math.PI/2);x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('log‚ÇÅ‚ÇÄ C(t)',0,0);x.restore();
    x.font=`italic ${Math.max(9,w*.01)}px 'EB Garamond',serif`;x.fillStyle=R(GD[0],GD[1],GD[2],.3);x.textAlign='center';x.fillText('Trading days',mx2+cw*.5,my2+ch2+14);

    if(upTo>0){
      const alarmCount=alarms.filter(a=>a<=upTo).length;
      x.font=`${Math.max(11,w*.014)}px 'EB Garamond',serif`;x.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.45);x.textAlign='right';x.fillText(`C = ${cusum[upTo].toFixed(1)}  ¬∑  Alarms: ${alarmCount}`,mx2+cw,my2+10);
    }

    if(prog<1)AF.regime=requestAnimationFrame(d);
  }
  stopAF('regime');start=0;AF.regime=requestAnimationFrame(d);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê  X. NEUROSCIENCE  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initNeuro(){
  document.getElementById('nr-act').oninput=function(){document.getElementById('nr-act-d').textContent=this.value+'%';};
  document.getElementById('nr-mu').oninput=function(){document.getElementById('nr-mu-d').textContent=parseFloat(this.value).toFixed(2);};

  const actPct=parseInt(document.getElementById('nr-act').value);
  const mu=parseFloat(document.getElementById('nr-mu').value);
  const K=40, T=80, alpha=0.05;
  const nActive=Math.round(K*actPct/100);
  const thresholdVal=1/alpha; // = 20

  // TwoSidedNormalMixture.best_rho (martingales.py line 106-108)
  const v_opt=T/2;
  const rho=v_opt/(2*Math.log(1/alpha)+Math.log(1+2*Math.log(1/alpha)));

  // Generate voxel data
  const isActive=[], signals=[], wealth=[];
  for(let k=0;k<K;k++){
    const active=k<nActive;
    isActive.push(active);
    const drift=active?mu:0;
    const sig=[], w=[1];
    let cumSum=0;
    for(let t=0;t<T;t++){
      const obs=drift+G();
      sig.push(obs);
      cumSum+=obs;
      const v=t+1;
      // TwoSidedNormalMixture.log_superMG (martingales.py line 95-97)
      const logM=0.5*Math.log(rho/(v+rho))+cumSum*cumSum/(2*(v+rho));
      w.push(Math.exp(logM));
    }
    signals.push(sig);
    wealth.push(w);
  }

  // Shuffle so active voxels aren't grouped
  const order=Array.from({length:K},(_,i)=>i);
  for(let i=K-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[order[i],order[j]]=[order[j],order[i]];}

  // ‚îÄ‚îÄ‚îÄ BRAIN VOXEL GRID ‚îÄ‚îÄ‚îÄ
  // Generate a grid of cells inside a brain-shaped mask (top-down axial view)
  const brainCols=14, brainRows=16;
  const brainCells=[]; // {col,row,voxelIdx or -1}
  // Brain outline: two hemispheres (ellipses) with fissure gap
  function inBrain(col,row){
    const cx=col/(brainCols-1)*2-1; // -1 to 1
    const cy=row/(brainRows-1)*2-1;
    // Vertical ellipse with slight front bulge
    const frontBulge=1+0.15*(1-cy); // wider at front (top)
    const rx=0.82*frontBulge, ry=0.92;
    const inEllipse=(cx*cx)/(rx*rx)+(cy*cy)/(ry*ry)<1;
    // Longitudinal fissure (narrow gap in center)
    const fissureWidth=0.06+0.04*Math.abs(cy);
    const inFissure=Math.abs(cx)<fissureWidth&&Math.abs(cy)<0.75;
    return inEllipse&&!inFissure;
  }
  // Collect valid cells
  const validCells=[];
  for(let r=0;r<brainRows;r++){
    for(let c=0;c<brainCols;c++){
      if(inBrain(c,r))validCells.push({col:c,row:r});
    }
  }
  // Assign tested voxels to random brain positions
  const cellAssign=new Array(validCells.length).fill(-1);
  const voxelPositions=[];
  // Spread active voxels in clusters for realism
  const assignIndices=Array.from({length:validCells.length},(_,i)=>i);
  for(let i=assignIndices.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[assignIndices[i],assignIndices[j]]=[assignIndices[j],assignIndices[i]];}
  for(let k=0;k<K&&k<assignIndices.length;k++){
    cellAssign[assignIndices[k]]=k;
  }

  // Brain canvas
  const cB=document.getElementById('c-brain');const{x:xB,w:wB,h:hB}=sCanvas(cB);
  // Scan line state
  let scanPulsePhase=0;

  // ‚îÄ‚îÄ‚îÄ DRAW BRAIN ‚îÄ‚îÄ‚îÄ
  function drawBrain(upTo,elapsed){
    xB.fillStyle=R(6,5,4,1);xB.fillRect(0,0,wB,hB);
    glow(xB,wB*.5,hB*.46,wB*.3,[10,8,5],.06);

    const bx=wB*.5, by=hB*.46;
    const bw=Math.min(wB*.42,hB*.42);

    // ‚îÄ‚îÄ Brain outline (subtle glow) ‚îÄ‚îÄ
    // Left hemisphere
    xB.save();
    xB.beginPath();
    xB.ellipse(bx-bw*0.02,by,bw*0.48,bw*0.56,0,0,Math.PI*2);
    const bgGrad=xB.createRadialGradient(bx,by,bw*0.1,bx,by,bw*0.6);
    bgGrad.addColorStop(0,R(20,16,10,.15));
    bgGrad.addColorStop(1,R(10,8,5,.02));
    xB.fillStyle=bgGrad;xB.fill();
    // Right hemisphere
    xB.beginPath();
    xB.ellipse(bx+bw*0.02,by,bw*0.48,bw*0.56,0,0,Math.PI*2);
    xB.fillStyle=bgGrad;xB.fill();
    xB.restore();

    // ‚îÄ‚îÄ Voxel grid cells ‚îÄ‚îÄ
    const cellW=bw*0.85/brainCols;
    const cellH=bw*1.05/brainRows;
    const gridX=bx-brainCols*cellW/2;
    const gridY=by-brainRows*cellH/2;

    for(let ci=0;ci<validCells.length;ci++){
      const cell=validCells[ci];
      const cx=gridX+cell.col*cellW;
      const cy=gridY+cell.row*cellH;
      const vk=cellAssign[ci];

      let r,g,b,a;
      if(vk<0){
        // Untested brain tissue ‚Äî very dim
        r=22;g=18;b=12;a=0.25;
      } else {
        // Tested voxel ‚Äî color by current wealth
        const wt=upTo<=T?wealth[vk][Math.min(upTo,T)]:wealth[vk][T];
        const logW=Math.log10(Math.max(wt,1e-6));
        const crossed=wt>=thresholdVal;

        if(crossed){
          // Discovery ‚Äî bright gold with pulse
          const pulse=0.8+0.2*Math.sin(elapsed*0.006+vk);
          r=240;g=210;b=80;a=0.7*pulse;
        } else if(logW>0.3){
          // Growing evidence ‚Äî teal-warm blend
          const t=clamp(logW/Math.log10(thresholdVal),0,1);
          r=Math.round(90+150*t);g=Math.round(176-80*t);b=Math.round(158-110*t);
          a=0.2+0.45*t;
        } else if(logW>-0.3){
          // Near baseline ‚Äî dim teal
          r=60;g=100;b=90;a=0.12;
        } else {
          // Below baseline ‚Äî cool
          r=30;g=40;b=50;a=0.1;
        }
      }

      // Rounded rect voxel
      const pad=0.8;
      const rr=1.5;
      xB.fillStyle=R(r,g,b,a);
      xB.beginPath();
      xB.roundRect(cx+pad,cy+pad,cellW-pad*2,cellH-pad*2,rr);
      xB.fill();

      // Glow for discoveries
      if(vk>=0){
        const wt=upTo<=T?wealth[vk][Math.min(upTo,T)]:wealth[vk][T];
        if(wt>=thresholdVal){
          glow(xB,cx+cellW/2,cy+cellH/2,cellW*0.8,[240,210,80],.08);
        }
      }
    }

    // ‚îÄ‚îÄ Brain outline stroke ‚îÄ‚îÄ
    xB.strokeStyle=R(GD[0],GD[1],GD[2],.1);
    xB.lineWidth=0.8;
    // Left hemisphere
    xB.beginPath();
    for(let i=0;i<=60;i++){
      const ang=i/60*Math.PI*2;
      const cx2=Math.cos(ang),sy2=Math.sin(ang);
      const frontBulge=1+0.15*(1-sy2);
      const px=bx-bw*0.02+cx2*bw*0.48*frontBulge*0.82;
      const py=by+sy2*bw*0.56*0.92;
      if(i===0)xB.moveTo(px,py);else xB.lineTo(px,py);
    }
    xB.stroke();
    // Right hemisphere
    xB.beginPath();
    for(let i=0;i<=60;i++){
      const ang=i/60*Math.PI*2;
      const cx2=Math.cos(ang),sy2=Math.sin(ang);
      const frontBulge=1+0.15*(1-sy2);
      const px=bx+bw*0.02+cx2*bw*0.48*frontBulge*0.82;
      const py=by+sy2*bw*0.56*0.92;
      if(i===0)xB.moveTo(px,py);else xB.lineTo(px,py);
    }
    xB.stroke();

    // ‚îÄ‚îÄ Scan progress bar ‚îÄ‚îÄ
    const barW=bw*1.2, barH=4;
    const barX=bx-barW/2, barY=by+bw*0.65;
    const prog=clamp(upTo/T,0,1);
    xB.fillStyle=R(GD[0],GD[1],GD[2],.08);
    xB.fillRect(barX,barY,barW,barH);
    xB.fillStyle=R(TEAL[0],TEAL[1],TEAL[2],.25);
    xB.fillRect(barX,barY,barW*prog,barH);
    // Scan line
    if(prog<1){
      const slx=barX+barW*prog;
      xB.fillStyle=R(TEAL[0],TEAL[1],TEAL[2],.6);
      xB.fillRect(slx-1,barY-1,2,barH+2);
    }
    xB.font=`${Math.max(9,wB*.012)}px 'EB Garamond',serif`;
    xB.fillStyle=R(GD[0],GD[1],GD[2],.3);xB.textAlign='left';
    xB.fillText(`VOL ${Math.min(upTo,T)}/${T}`,barX,barY-4);

    // ‚îÄ‚îÄ Discovery counter ‚îÄ‚îÄ
    let nDisc=0;
    for(let k=0;k<K;k++){
      const wt=upTo<=T?wealth[k][Math.min(upTo,T)]:wealth[k][T];
      if(wt>=thresholdVal)nDisc++;
    }
    xB.textAlign='right';
    xB.font=`${Math.max(11,wB*.015)}px 'EB Garamond',serif`;
    xB.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.4);
    xB.fillText(`${nDisc} discoveries  ¬∑  ${K} voxels tested  ¬∑  Œ± = ${alpha}`,barX+barW,barY-4);

    // ‚îÄ‚îÄ Region labels (subtle) ‚îÄ‚îÄ
    xB.font=`italic ${Math.max(8,wB*.009)}px 'EB Garamond',serif`;
    xB.fillStyle=R(GD[0],GD[1],GD[2],.12);xB.textAlign='center';
    xB.fillText('frontal',bx,gridY-6);
    xB.fillText('occipital',bx,gridY+brainRows*cellH+12);
    xB.fillText('L',gridX-10,by+2);
    xB.fillText('R',gridX+brainCols*cellW+10,by+2);
  }
  function project(px,py,pz, rY,rX, cx,cy,sc){
    const cY=Math.cos(rY),sY=Math.sin(rY);
    let x1=px*cY+pz*sY, z1=-px*sY+pz*cY, y1=py;
    const cX=Math.cos(rX),sX=Math.sin(rX);
    let y2=y1*cX-z1*sX, z2=y1*sX+z1*cX;
    const fov=4.5;
    const d=fov/(fov+z2);
    return{sx:cx+x1*d*sc, sy:cy-y2*d*sc, d:d, z:z2};
  }

  function line3D(x,a,b,rY,rX,cx,cy,sc){
    const pa=project(a[0],a[1],a[2],rY,rX,cx,cy,sc);
    const pb=project(b[0],b[1],b[2],rY,rX,cx,cy,sc);
    x.beginPath();x.moveTo(pa.sx,pa.sy);x.lineTo(pb.sx,pb.sy);x.stroke();
  }

  // ‚îÄ‚îÄ‚îÄ DRAW WIREFRAME CUBE ‚îÄ‚îÄ‚îÄ
  function drawCube(x,w,h,rY,rX,cx,cy,sc,al){
    // Cube corners at ¬±1
    const C=[
      [-1,-1,-1],[ 1,-1,-1],[ 1, 1,-1],[-1, 1,-1],
      [-1,-1, 1],[ 1,-1, 1],[ 1, 1, 1],[-1, 1, 1]
    ];
    const edges=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];
    x.strokeStyle=R(GD[0],GD[1],GD[2],al);
    x.lineWidth=0.6;
    edges.forEach(([a,b])=>line3D(x,C[a],C[b],rY,rX,cx,cy,sc));
  }

  // ‚îÄ‚îÄ‚îÄ DRAW THRESHOLD PLANE ‚îÄ‚îÄ‚îÄ
  function drawThresholdPlane(x,yNorm,rY,rX,cx,cy,sc){
    // Horizontal plane at y=yNorm spanning x/z of the cube
    const steps=8;
    x.strokeStyle=R(RED[0],RED[1],RED[2],.06);
    x.lineWidth=0.4;
    // Grid lines in X direction
    for(let i=0;i<=steps;i++){
      const z=-1+2*i/steps;
      const pa=project(-1,yNorm,z,rY,rX,cx,cy,sc);
      const pb=project( 1,yNorm,z,rY,rX,cx,cy,sc);
      x.beginPath();x.moveTo(pa.sx,pa.sy);x.lineTo(pb.sx,pb.sy);x.stroke();
    }
    // Grid lines in Z direction
    for(let i=0;i<=steps;i++){
      const xv=-1+2*i/steps;
      const pa=project(xv,yNorm,-1,rY,rX,cx,cy,sc);
      const pb=project(xv,yNorm, 1,rY,rX,cx,cy,sc);
      x.beginPath();x.moveTo(pa.sx,pa.sy);x.lineTo(pb.sx,pb.sy);x.stroke();
    }
    // Border
    x.strokeStyle=R(RED[0],RED[1],RED[2],.12);
    x.lineWidth=0.7;
    const corners=[[-1,yNorm,-1],[1,yNorm,-1],[1,yNorm,1],[-1,yNorm,1]];
    x.beginPath();
    corners.forEach((c,i)=>{
      const p=project(c[0],c[1],c[2],rY,rX,cx,cy,sc);
      if(i===0)x.moveTo(p.sx,p.sy);else x.lineTo(p.sx,p.sy);
    });
    x.closePath();x.stroke();
    // Label
    const lp=project(1.12,yNorm,-1,rY,rX,cx,cy,sc);
    x.font=`italic ${Math.max(9,cy*.035)}px 'EB Garamond',serif`;
    x.fillStyle=R(RED[0],RED[1],RED[2],.25);x.textAlign='left';
    x.fillText('1/Œ±',lp.sx,lp.sy+3);
  }

  // ‚îÄ‚îÄ‚îÄ DRAW AXIS LABELS ‚îÄ‚îÄ‚îÄ
  function drawLabels(x,rY,rX,cx,cy,sc,isEP){
    // Time arrow along bottom-front edge
    const ta=project(-1,-1.12,-1,rY,rX,cx,cy,sc);
    const tb=project( 1,-1.12,-1,rY,rX,cx,cy,sc);
    x.strokeStyle=R(GD[0],GD[1],GD[2],.1);x.lineWidth=0.5;
    x.beginPath();x.moveTo(ta.sx,ta.sy);x.lineTo(tb.sx,tb.sy);x.stroke();
    // arrowhead
    const dx=tb.sx-ta.sx,dy=tb.sy-ta.sy,len=Math.sqrt(dx*dx+dy*dy);
    const ux=dx/len,uy=dy/len;
    x.beginPath();x.moveTo(tb.sx,tb.sy);x.lineTo(tb.sx-ux*6+uy*3,tb.sy-uy*6-ux*3);x.moveTo(tb.sx,tb.sy);x.lineTo(tb.sx-ux*6-uy*3,tb.sy-uy*6+ux*3);x.stroke();
    x.font=`italic ${Math.max(9,cy*.032)}px 'EB Garamond',serif`;
    x.fillStyle=R(GD[0],GD[1],GD[2],.2);x.textAlign='center';
    x.fillText('time',tb.sx+8,tb.sy+2);

    // Voxel axis along bottom-right edge
    const va=project(1,-1.12,-1,rY,rX,cx,cy,sc);
    const vb=project(1,-1.12, 1,rY,rX,cx,cy,sc);
    x.strokeStyle=R(GD[0],GD[1],GD[2],.07);
    x.beginPath();x.moveTo(va.sx,va.sy);x.lineTo(vb.sx,vb.sy);x.stroke();
    x.fillText('voxels',vb.sx,vb.sy+12);

    // Y axis label
    const ya=project(-1.15, 0,-1,rY,rX,cx,cy,sc);
    x.fillText(isEP?'log‚ÇÅ‚ÇÄ M(t)':'BOLD',ya.sx-10,ya.sy);
  }

  // ‚îÄ‚îÄ‚îÄ MAIN DRAW ‚îÄ‚îÄ‚îÄ
  function drawScene(x,w,h,rY,rX,upTo,isEP){
    x.fillStyle=R(6,5,4,1);x.fillRect(0,0,w,h);
    glow(x,w*.48,h*.48,w*.32,[12,9,5],.08);

    const cx=w*.5, cy=h*.5, sc=Math.min(w,h)*.36;

    // Value ranges for mapping into [-1,1] cube
    let yMin,yMax;
    if(isEP){
      yMin=-1; yMax=Math.log10(thresholdVal)*1.8;
    } else {
      yMin=-3; yMax=3;
    }

    // Draw cube
    drawCube(x,w,h,rY,rX,cx,cy,sc,0.08);

    // Threshold plane (e-process only)
    if(isEP){
      const thNorm=(Math.log10(thresholdVal)-yMin)/(yMax-yMin)*2-1;
      drawThresholdPlane(x,thNorm,rY,rX,cx,cy,sc);
    }

    // Sort voxels back-to-front
    const sorted=[];
    for(let ki=0;ki<K;ki++){
      const k=order[ki];
      const zNorm=(ki/(K-1))*2-1;
      const midP=project(0,0,zNorm,rY,rX,0,0,1);
      sorted.push({k,ki,zNorm,vz:midP.z});
    }
    sorted.sort((a,b)=>b.vz-a.vz);

    // Draw trajectories
    const nPts=Math.min(upTo+1, T+1);
    for(const v of sorted){
      const k=v.k, zN=v.zNorm;
      const active=isActive[k];
      const depth=clamp((v.vz+3)/6,0,1);
      const fade=0.2+0.8*(1-depth);

      if(nPts<2)continue;

      // For e-process: find crossing time
      let crossT=-1;
      if(isEP){
        for(let t=1;t<nPts&&t<=T;t++){
          if(wealth[k][t]>=thresholdVal){crossT=t;break;}
        }
      }

      // Draw path in segments ‚Äî color changes at crossing
      for(let t=1;t<nPts;t++){
        const tI=t-1, tJ=t;
        const rawI=isEP?wealth[k][tI]:(tI<T?signals[k][tI]:signals[k][T-1]);
        const rawJ=isEP?wealth[k][tJ]:(tJ<T?signals[k][tJ]:signals[k][T-1]);
        const yI=isEP?Math.log10(Math.max(rawI,1e-6)):rawI;
        const yJ=isEP?Math.log10(Math.max(rawJ,1e-6)):rawJ;

        const xI=(tI/T)*2-1, xJ=(tJ/T)*2-1;
        const yNI=clamp((yI-yMin)/(yMax-yMin)*2-1,-1,1);
        const yNJ=clamp((yJ-yMin)/(yMax-yMin)*2-1,-1,1);

        const pI=project(xI,yNI,zN,rY,rX,cx,cy,sc);
        const pJ=project(xJ,yNJ,zN,rY,rX,cx,cy,sc);

        // Color logic
        let col,al,lw;
        if(isEP && crossT>=0 && tJ>=crossT){
          // CROSSED ‚Äî bright gold
          col=GB; al=0.8*fade; lw=2.0*fade;
        } else if(isEP && active){
          // Active, not yet crossed ‚Äî teal
          col=TEAL; al=0.35*fade; lw=1.0*fade;
        } else if(!isEP && active){
          col=TEAL; al=0.3*fade; lw=0.8*fade;
        } else {
          // Null voxel
          col=GD; al=0.06*fade; lw=0.35*fade;
        }

        x.strokeStyle=R(col[0],col[1],col[2],al);
        x.lineWidth=lw;
        x.beginPath();x.moveTo(pI.sx,pI.sy);x.lineTo(pJ.sx,pJ.sy);x.stroke();
      }

      // Head dot
      if(nPts>1 && (active || (isEP && crossT>=0))){
        const tH=nPts-1;
        const rawH=isEP?wealth[k][tH]:(tH<T?signals[k][tH]:signals[k][T-1]);
        const yH=isEP?Math.log10(Math.max(rawH,1e-6)):rawH;
        const xH=(tH/T)*2-1;
        const yNH=clamp((yH-yMin)/(yMax-yMin)*2-1,-1,1);
        const pH=project(xH,yNH,zN,rY,rX,cx,cy,sc);

        const crossed=isEP&&crossT>=0;
        const hCol=crossed?GB:(active?TEAL:GD);
        const hAl=crossed?0.9*fade:0.5*fade;
        if(crossed)glow(x,pH.sx,pH.sy,8*fade,GB,.15*fade);
        x.fillStyle=R(hCol[0],hCol[1],hCol[2],hAl);
        x.beginPath();x.arc(pH.sx,pH.sy,crossed?2.5:1.5,0,Math.PI*2);x.fill();
      }
    }

    // Labels
    drawLabels(x,rY,rX,cx,cy,sc,isEP);
  }

  // Canvases
  const c1=document.getElementById('c-neuro-sig');const{x:x1,w:w1,h:h1}=sCanvas(c1);
  const c2=document.getElementById('c-neuro-ep');const{x:x2,w:w2,h:h2}=sCanvas(c2);
  let start=0;

  // ‚îÄ‚îÄ‚îÄ DRAG ROTATION STATE ‚îÄ‚îÄ‚îÄ
  let dragRY=-0.55, dragRX=0.3; // user-controlled angles
  let isDragging=false, dragStartX=0, dragStartY=0, dragBaseRY=0, dragBaseRX=0;
  let autoRotate=true, lastInteract=0;
  const SENSITIVITY=0.006;

  function onPointerDown(e){
    isDragging=true;autoRotate=false;lastInteract=performance.now();
    dragStartX=e.clientX||(e.touches&&e.touches[0].clientX);
    dragStartY=e.clientY||(e.touches&&e.touches[0].clientY);
    dragBaseRY=dragRY;dragBaseRX=dragRX;
    e.currentTarget.style.cursor='grabbing';
    e.preventDefault();
  }
  function onPointerMove(e){
    if(!isDragging)return;
    const cx=e.clientX||(e.touches&&e.touches[0].clientX);
    const cy=e.clientY||(e.touches&&e.touches[0].clientY);
    if(cx===undefined)return;
    dragRY=dragBaseRY+(cx-dragStartX)*SENSITIVITY;
    dragRX=clamp(dragBaseRX-(cy-dragStartY)*SENSITIVITY,-1.2,1.2);
    e.preventDefault();
  }
  function onPointerUp(){
    isDragging=false;lastInteract=performance.now();
    c1.style.cursor='grab';c2.style.cursor='grab';
  }
  // Clean up previous listeners if re-initing
  if(window._neuroCleanup)window._neuroCleanup();
  [c1,c2].forEach(c=>{
    c.style.cursor='grab';
    c.addEventListener('mousedown',onPointerDown);
    c.addEventListener('touchstart',onPointerDown,{passive:false});
  });
  document.addEventListener('mousemove',onPointerMove);
  document.addEventListener('touchmove',onPointerMove,{passive:false});
  document.addEventListener('mouseup',onPointerUp);
  document.addEventListener('touchend',onPointerUp);
  window._neuroCleanup=()=>{
    [c1,c2].forEach(c=>{
      c.removeEventListener('mousedown',onPointerDown);
      c.removeEventListener('touchstart',onPointerDown);
    });
    document.removeEventListener('mousemove',onPointerMove);
    document.removeEventListener('touchmove',onPointerMove);
    document.removeEventListener('mouseup',onPointerUp);
    document.removeEventListener('touchend',onPointerUp);
  };

  function d(t){
    if(!start)start=t;
    const el=t-start;
    const prog=Math.min(1,el/22000);
    const upTo=Math.floor(prog*T);

    // Resume gentle auto-rotation after 3s of no interaction
    if(!isDragging&&!autoRotate&&(performance.now()-lastInteract)>3000)autoRotate=true;
    if(autoRotate){
      dragRY+=-0.0001*Math.cos(el*0.00018);
      dragRX+=0.00003*Math.cos(el*0.00012);
      dragRX=clamp(dragRX,-1.2,1.2);
    }

    drawBrain(upTo,el);
    drawScene(x1,w1,h1,dragRY,dragRX,upTo,false);
    drawScene(x2,w2,h2,dragRY,dragRX,upTo,true);

    // Stats overlay
    if(upTo>5){
      let nDisc=0,nFalse=0;
      for(let k=0;k<K;k++){
        let crossed=false;
        for(let tt=1;tt<=upTo&&tt<=T;tt++){if(wealth[k][tt]>=thresholdVal){crossed=true;break;}}
        if(crossed){nDisc++;if(!isActive[k])nFalse++;}
      }
      const fdp=nDisc>0?(nFalse/nDisc*100).toFixed(0):'0';
      x2.font=`${Math.max(11,w2*.014)}px 'EB Garamond',serif`;
      x2.fillStyle=R(GOLD[0],GOLD[1],GOLD[2],.45);x2.textAlign='right';
      x2.fillText(`Discoveries: ${nDisc}/${K}  ¬∑  FDP: ${fdp}%  ¬∑  True active: ${nActive}`,w2*.93,h2*.06);
    }

    AF.neuro=requestAnimationFrame(d);
  }

  stopAF('neuro');start=0;AF.neuro=requestAnimationFrame(d);
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
window.addEventListener('resize',()=>{const active=document.querySelector('.nav-tab.active');if(active)setTimeout(()=>initPage(active.dataset.page),100);});
setTimeout(initPrologue,200);
</script>
</body>
</html>
